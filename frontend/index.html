<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Table Management System</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2c1810;
      --secondary: #8b6f47;
      --accent: #d4af37;
      --bg-light: #faf8f5;
      --bg-dark: #1a1410;
      --text-dark: #2c1810;
      --text-light: #f5f5f5;
      --border: #e8dfd0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      overflow-x: hidden;
    }

    .font-serif {
      font-family: 'Cormorant Garamond', serif;
    }

    .gradient-primary {
      background: linear-gradient(135deg, #2c1810 0%, #4a3425 100%);
    }

    .gradient-accent {
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
    }

    .glass {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 175, 55, 0.2);
    }

    .table-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .table-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.2), transparent);
      transition: left 0.5s;
    }

    .table-card:hover::before {
      left: 100%;
    }

    .table-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(44, 24, 16, 0.15);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-up {
      animation: fadeInUp 0.6s ease-out forwards;
    }

    .pattern-bg {
      background-image: 
        linear-gradient(rgba(212, 175, 55, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(212, 175, 55, 0.03) 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--primary);
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.875rem;
    }

    .btn-primary:hover {
      background: #f4d03f;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(212, 175, 55, 0.3);
    }

    .btn-secondary {
      background: white;
      color: var(--primary);
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      background: var(--bg-light);
    }

    input, select, textarea {
      font-family: 'Outfit', sans-serif;
    }

    .input-field {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s;
      background: white;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }

    .draggable-table {
      position: absolute;
      cursor: move;
      user-select: none;
      transition: box-shadow 0.2s;
    }

    .draggable-table:active {
      cursor: grabbing;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .canvas-container {
      position: relative;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background-image: 
        radial-gradient(circle at 20px 20px, rgba(212, 175, 55, 0.05) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .qr-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      animation: fadeInUp 0.3s ease-out;
    }

    .stat-card {
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: var(--accent);
      box-shadow: 0 10px 30px rgba(212, 175, 55, 0.1);
    }

    .guest-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s;
    }

    .guest-card:hover {
      border-color: var(--accent);
      background: var(--bg-light);
    }

    @media (max-width: 768px) {
      .btn-primary, .btn-secondary {
        padding: 0.625rem 1.25rem;
        font-size: 0.8125rem;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Configuration
    const API_BASE = 'https://table-management-system-kagg.onrender.com/api';
    const GUEST_BASE_URL = window.location.origin + window.location.pathname + '#/guest/';

    // ==================== COMPONENTS ====================

    // Navigation Component
    function Navigation({ currentView, onNavigate }) {
      return (
        <nav className="gradient-primary text-white shadow-lg">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 rounded-full bg-accent flex items-center justify-center">
                  <span className="text-2xl">üé™</span>
                </div>
                <h1 className="font-serif text-2xl font-bold tracking-wide">Table Manager</h1>
              </div>
              <div className="flex space-x-4">
                <button
                  onClick={() => onNavigate('events')}
                  className={`px-4 py-2 rounded-lg transition-all ${
                    currentView === 'events' 
                      ? 'bg-accent text-primary font-semibold' 
                      : 'hover:bg-white/10'
                  }`}
                >
                  Events
                </button>
                <button
                  onClick={() => onNavigate('demo')}
                  className={`px-4 py-2 rounded-lg transition-all ${
                    currentView === 'demo' 
                      ? 'bg-accent text-primary font-semibold' 
                      : 'hover:bg-white/10'
                  }`}
                >
                  Guest Demo
                </button>
              </div>
            </div>
          </div>
        </nav>
      );
    }

    // Events List Component
    function EventsList({ onSelectEvent, onCreateEvent }) {
      const [events, setEvents] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetchEvents();
      }, []);

      const fetchEvents = async () => {
        try {
          const response = await fetch(`${API_BASE}/events`);
          const data = await response.json();
          setEvents(data);
        } catch (error) {
          console.error('Error fetching events:', error);
        } finally {
          setLoading(false);
        }
      };

      if (loading) {
        return (
          <div className="flex justify-center items-center h-96">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-secondary">Loading events...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 pattern-bg">
          <div className="flex justify-between items-center mb-8 animate-fade-in-up">
            <div>
              <h2 className="font-serif text-4xl font-bold text-primary mb-2">Your Events</h2>
              <p className="text-secondary text-lg">Manage wedding dinners, banquets, and celebrations</p>
            </div>
            <button onClick={onCreateEvent} className="btn-primary">
              ‚ú® Create Event
            </button>
          </div>

          {events.length === 0 ? (
            <div className="text-center py-20 animate-fade-in-up" style={{ animationDelay: '0.1s' }}>
              <div className="text-8xl mb-6">üéâ</div>
              <h3 className="font-serif text-3xl font-bold text-primary mb-3">No events yet</h3>
              <p className="text-secondary text-lg mb-6">Create your first event to start managing tables and guests</p>
              <button onClick={onCreateEvent} className="btn-primary">
                Create Your First Event
              </button>
            </div>
          ) : (
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              {events.map((event, index) => (
                <div
                  key={event.id}
                  onClick={() => onSelectEvent(event.id)}
                  className="table-card glass rounded-xl p-6 animate-fade-in-up"
                  style={{ animationDelay: `${index * 0.1}s` }}
                >
                  <div className="flex items-start justify-between mb-4">
                    <div className="w-12 h-12 rounded-full gradient-accent flex items-center justify-center text-2xl">
                      üéä
                    </div>
                    <span className="text-xs text-secondary bg-accent/10 px-3 py-1 rounded-full">
                      {new Date(event.date).toLocaleDateString()}
                    </span>
                  </div>
                  <h3 className="font-serif text-2xl font-bold text-primary mb-2">{event.name}</h3>
                  <p className="text-secondary mb-4">üìç {event.venue || 'Venue TBD'}</p>
                  <div className="flex items-center justify-between pt-4 border-t border-border">
                    <span className="text-sm text-secondary">View Details</span>
                    <span className="text-accent text-xl">‚Üí</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Create Event Modal
    function CreateEventModal({ onClose, onSuccess }) {
      const [formData, setFormData] = useState({
        name: '',
        date: '',
        venue: ''
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        try {
          const response = await fetch(`${API_BASE}/events`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          const data = await response.json();
          onSuccess(data.id);
        } catch (error) {
          console.error('Error creating event:', error);
        }
      };

      return (
        <div className="qr-modal" onClick={onClose}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="font-serif text-3xl font-bold text-primary mb-6">Create New Event</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-primary mb-2">Event Name *</label>
                <input
                  type="text"
                  required
                  className="input-field"
                  placeholder="e.g., Sarah & John's Wedding"
                  value={formData.name}
                  onChange={e => setFormData({ ...formData, name: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-primary mb-2">Date *</label>
                <input
                  type="date"
                  required
                  className="input-field"
                  value={formData.date}
                  onChange={e => setFormData({ ...formData, date: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-primary mb-2">Venue</label>
                <input
                  type="text"
                  className="input-field"
                  placeholder="e.g., Grand Ballroom, Hotel Continental"
                  value={formData.venue}
                  onChange={e => setFormData({ ...formData, venue: e.target.value })}
                />
              </div>
              <div className="flex space-x-3 pt-4">
                <button type="submit" className="btn-primary flex-1">Create Event</button>
                <button type="button" onClick={onClose} className="btn-secondary flex-1">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // Event Dashboard Component
    function EventDashboard({ eventId, onBack }) {
      const [event, setEvent] = useState(null);
      const [tables, setTables] = useState([]);
      const [guests, setGuests] = useState([]);
      const [activeTab, setActiveTab] = useState('overview');
      const [showCreateTable, setShowCreateTable] = useState(false);
      const [showAddGuest, setShowAddGuest] = useState(false);
      const [selectedGuest, setSelectedGuest] = useState(null);

      useEffect(() => {
        fetchEventData();
      }, [eventId]);

      const fetchEventData = async () => {
        try {
          const [eventRes, tablesRes, guestsRes] = await Promise.all([
            fetch(`${API_BASE}/events/${eventId}`),
            fetch(`${API_BASE}/events/${eventId}/tables`),
            fetch(`${API_BASE}/events/${eventId}/guests`)
          ]);
          setEvent(await eventRes.json());
          setTables(await tablesRes.json());
          setGuests(await guestsRes.json());
        } catch (error) {
          console.error('Error fetching event data:', error);
        }
      };

      if (!event) {
        return (
          <div className="flex justify-center items-center h-96">
            <div className="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
          </div>
        );
      }

      return (
        <div className="min-h-screen pattern-bg">
          {/* Header */}
          <div className="gradient-primary text-white shadow-lg">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
              <button onClick={onBack} className="mb-4 text-accent hover:text-white transition-colors flex items-center space-x-2">
                <span>‚Üê</span>
                <span>Back to Events</span>
              </button>
              <div className="flex justify-between items-start">
                <div>
                  <h1 className="font-serif text-4xl font-bold mb-2">{event.name}</h1>
                  <p className="text-white/80 text-lg">
                    üìÖ {new Date(event.date).toLocaleDateString()} ‚Ä¢ üìç {event.venue || 'Venue TBD'}
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Stats Cards */}
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-6 mb-8">
            <div className="grid md:grid-cols-4 gap-4">
              <div className="stat-card">
                <div className="text-3xl mb-2">üéØ</div>
                <div className="text-2xl font-bold text-primary">{event.stats?.totalTables || 0}</div>
                <div className="text-sm text-secondary">Total Tables</div>
              </div>
              <div className="stat-card">
                <div className="text-3xl mb-2">üí∫</div>
                <div className="text-2xl font-bold text-primary">{event.stats?.totalSeats || 0}</div>
                <div className="text-sm text-secondary">Total Seats</div>
              </div>
              <div className="stat-card">
                <div className="text-3xl mb-2">üë•</div>
                <div className="text-2xl font-bold text-primary">{event.stats?.assignedGuests || 0}</div>
                <div className="text-sm text-secondary">Guests Assigned</div>
              </div>
              <div className="stat-card">
                <div className="text-3xl mb-2">‚ú®</div>
                <div className="text-2xl font-bold text-primary">{event.stats?.remainingSeats || 0}</div>
                <div className="text-sm text-secondary">Seats Remaining</div>
              </div>
            </div>
          </div>

          {/* Tabs */}
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
            <div className="bg-white rounded-xl border-2 border-border p-2 inline-flex space-x-2">
              {['overview', 'tables', 'guests'].map(tab => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={`px-6 py-2 rounded-lg font-semibold transition-all capitalize ${
                    activeTab === tab 
                      ? 'bg-accent text-primary shadow-md' 
                      : 'text-secondary hover:bg-gray-50'
                  }`}
                >
                  {tab}
                </button>
              ))}
            </div>
          </div>

          {/* Content */}
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
            {activeTab === 'overview' && <OverviewTab event={event} tables={tables} guests={guests} />}
            {activeTab === 'tables' && (
              <TablesTab 
                eventId={eventId} 
                tables={tables} 
                setTables={setTables}
                onRefresh={fetchEventData}
              />
            )}
            {activeTab === 'guests' && (
              <GuestsTab 
                eventId={eventId}
                guests={guests}
                tables={tables}
                onRefresh={fetchEventData}
              />
            )}
          </div>
        </div>
      );
    }

    // Overview Tab
    function OverviewTab({ event, tables, guests }) {
      return (
        <div className="space-y-8">
          <div className="glass rounded-xl p-8">
            <h3 className="font-serif text-2xl font-bold text-primary mb-6">Event Summary</h3>
            <div className="grid md:grid-cols-2 gap-6">
              <div>
                <h4 className="font-semibold text-primary mb-3">Quick Stats</h4>
                <ul className="space-y-2 text-secondary">
                  <li>‚Ä¢ {tables.length} tables configured</li>
                  <li>‚Ä¢ {guests.length} guest groups registered</li>
                  <li>‚Ä¢ {guests.filter(g => g.table_id).length} groups assigned to tables</li>
                  <li>‚Ä¢ {guests.filter(g => !g.table_id).length} groups pending assignment</li>
                </ul>
              </div>
              <div>
                <h4 className="font-semibold text-primary mb-3">Next Steps</h4>
                <ul className="space-y-2 text-secondary">
                  <li>‚úì Configure table layout in Tables tab</li>
                  <li>‚úì Add all guests in Guests tab</li>
                  <li>‚úì Assign guests to tables</li>
                  <li>‚úì Generate and distribute QR codes</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Tables Tab
    function TablesTab({ eventId, tables, setTables, onRefresh }) {
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [editingTable, setEditingTable] = useState(null);
      const canvasRef = useRef(null);
      const [draggedTable, setDraggedTable] = useState(null);
      const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });

      const handleCreateTables = async (tableData) => {
        try {
          await fetch(`${API_BASE}/events/${eventId}/tables`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tables: tableData })
          });
          setShowCreateModal(false);
          onRefresh();
        } catch (error) {
          console.error('Error creating tables:', error);
        }
      };

      const handleMouseDown = (e, table) => {
        const rect = e.currentTarget.getBoundingClientRect();
        setDragOffset({
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        });
        setDraggedTable(table);
      };

      const handleMouseMove = (e) => {
        if (!draggedTable || !canvasRef.current) return;
        
        const canvas = canvasRef.current.getBoundingClientRect();
        const x = Math.max(0, Math.min(canvas.width - 100, e.clientX - canvas.left - dragOffset.x));
        const y = Math.max(0, Math.min(canvas.height - 100, e.clientY - canvas.top - dragOffset.y));

        setTables(prev => prev.map(t => 
          t.id === draggedTable.id ? { ...t, position_x: x, position_y: y } : t
        ));
      };

      const handleMouseUp = async () => {
        if (draggedTable) {
          try {
            await fetch(`${API_BASE}/tables/${draggedTable.id}/position`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                position_x: draggedTable.position_x,
                position_y: draggedTable.position_y
              })
            });
          } catch (error) {
            console.error('Error updating position:', error);
          }
          setDraggedTable(null);
        }
      };

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h3 className="font-serif text-2xl font-bold text-primary">Table Layout</h3>
            <button onClick={() => setShowCreateModal(true)} className="btn-primary">
              + Create Tables
            </button>
          </div>

          {tables.length === 0 ? (
            <div className="text-center py-20 glass rounded-xl">
              <div className="text-6xl mb-4">ü™ë</div>
              <h4 className="font-serif text-2xl font-bold text-primary mb-2">No tables yet</h4>
              <p className="text-secondary mb-6">Create tables to start designing your event layout</p>
              <button onClick={() => setShowCreateModal(true)} className="btn-primary">
                Create Tables
              </button>
            </div>
          ) : (
            <div 
              ref={canvasRef}
              className="canvas-container h-[600px]"
              onMouseMove={handleMouseMove}
              onMouseUp={handleMouseUp}
              onMouseLeave={handleMouseUp}
            >
              {tables.map(table => (
                <div
                  key={table.id}
                  className="draggable-table glass rounded-lg p-4 w-24 h-24 flex flex-col items-center justify-center"
                  style={{
                    left: `${table.position_x}px`,
                    top: `${table.position_y}px`
                  }}
                  onMouseDown={(e) => handleMouseDown(e, table)}
                >
                  <div className="font-bold text-primary text-lg">{table.table_name}</div>
                  <div className="text-xs text-secondary">{table.seats_occupied}/{table.capacity}</div>
                  <div className="text-2xl mt-1">
                    {table.seats_occupied >= table.capacity ? 'üî¥' : 'üü¢'}
                  </div>
                </div>
              ))}
            </div>
          )}

          {showCreateModal && (
            <CreateTablesModal 
              onClose={() => setShowCreateModal(false)}
              onSubmit={handleCreateTables}
            />
          )}
        </div>
      );
    }

    // Create Tables Modal
    function CreateTablesModal({ onClose, onSubmit }) {
      const [numTables, setNumTables] = useState(10);
      const [seatsPerTable, setSeatsPerTable] = useState(10);
      const [prefix, setPrefix] = useState('T');

      const handleSubmit = (e) => {
        e.preventDefault();
        const tables = Array.from({ length: numTables }, (_, i) => ({
          table_name: `${prefix}${i + 1}`,
          capacity: seatsPerTable
        }));
        onSubmit(tables);
      };

      return (
        <div className="qr-modal" onClick={onClose}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="font-serif text-3xl font-bold text-primary mb-6">Create Tables</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-primary mb-2">Number of Tables</label>
                <input
                  type="number"
                  min="1"
                  max="100"
                  required
                  className="input-field"
                  value={numTables}
                  onChange={e => setNumTables(parseInt(e.target.value))}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-primary mb-2">Seats Per Table</label>
                <input
                  type="number"
                  min="1"
                  max="20"
                  required
                  className="input-field"
                  value={seatsPerTable}
                  onChange={e => setSeatsPerTable(parseInt(e.target.value))}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-primary mb-2">Table Prefix</label>
                <input
                  type="text"
                  maxLength="3"
                  required
                  className="input-field"
                  placeholder="e.g., T, A, Table"
                  value={prefix}
                  onChange={e => setPrefix(e.target.value)}
                />
                <p className="text-xs text-secondary mt-1">Tables will be named: {prefix}1, {prefix}2, ...</p>
              </div>
              <div className="flex space-x-3 pt-4">
                <button type="submit" className="btn-primary flex-1">Create {numTables} Tables</button>
                <button type="button" onClick={onClose} className="btn-secondary flex-1">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // Guests Tab
    function GuestsTab({ eventId, guests, tables, onRefresh }) {
      const [showAddModal, setShowAddModal] = useState(false);
      const [selectedGuest, setSelectedGuest] = useState(null);

      const handleAddGuest = async (guestData) => {
        try {
          await fetch(`${API_BASE}/events/${eventId}/guests`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(guestData)
          });
          setShowAddModal(false);
          onRefresh();
        } catch (error) {
          console.error('Error adding guest:', error);
        }
      };

      const handleAssignTable = async (guestId, tableId) => {
        try {
          await fetch(`${API_BASE}/guests/${guestId}/assign`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: tableId })
          });
          onRefresh();
        } catch (error) {
          console.error('Error assigning table:', error);
        }
      };

      const handleDeleteGuest = async (guestId) => {
        if (confirm('Are you sure you want to delete this guest?')) {
          try {
            await fetch(`${API_BASE}/guests/${guestId}`, {
              method: 'DELETE'
            });
            onRefresh();
          } catch (error) {
            console.error('Error deleting guest:', error);
          }
        }
      };

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h3 className="font-serif text-2xl font-bold text-primary">Guest List</h3>
            <button onClick={() => setShowAddModal(true)} className="btn-primary">
              + Add Guest
            </button>
          </div>

          {guests.length === 0 ? (
            <div className="text-center py-20 glass rounded-xl">
              <div className="text-6xl mb-4">üë•</div>
              <h4 className="font-serif text-2xl font-bold text-primary mb-2">No guests yet</h4>
              <p className="text-secondary mb-6">Add guests to generate QR invitations</p>
              <button onClick={() => setShowAddModal(true)} className="btn-primary">
                Add Your First Guest
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              {guests.map(guest => (
                <div key={guest.id} className="guest-card">
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <div className="flex items-center space-x-3 mb-1">
                        <h4 className="font-semibold text-primary">{guest.name}</h4>
                        {guest.group_name && (
                          <span className="text-xs bg-accent/20 text-secondary px-2 py-1 rounded">
                            {guest.group_name}
                          </span>
                        )}
                      </div>
                      <div className="text-sm text-secondary">
                        Party Size: {guest.party_size} ‚Ä¢ 
                        {guest.email && ` ${guest.email}`}
                        {guest.phone && ` ‚Ä¢ ${guest.phone}`}
                      </div>
                    </div>
                    <div className="flex items-center space-x-3">
                      <select
                        value={guest.table_id || ''}
                        onChange={(e) => handleAssignTable(guest.id, e.target.value || null)}
                        className="input-field text-sm py-2"
                      >
                        <option value="">No Table</option>
                        {tables.map(table => (
                          <option key={table.id} value={table.id}>
                            {table.table_name} ({table.seats_occupied}/{table.capacity})
                          </option>
                        ))}
                      </select>
                      <button
                        onClick={() => setSelectedGuest(guest)}
                        className="btn-secondary py-2 px-4 text-sm"
                      >
                        üì± QR
                      </button>
                      <button
                        onClick={() => handleDeleteGuest(guest.id)}
                        className="text-red-500 hover:text-red-700 text-xl"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {showAddModal && (
            <AddGuestModal
              onClose={() => setShowAddModal(false)}
              onSubmit={handleAddGuest}
              tables={tables}
            />
          )}

          {selectedGuest && (
            <QRCodeModal
              guest={selectedGuest}
              onClose={() => setSelectedGuest(null)}
            />
          )}
        </div>
      );
    }

    // Add Guest Modal
    function AddGuestModal({ onClose, onSubmit, tables }) {
      const [formData, setFormData] = useState({
        name: '',
        email: '',
        phone: '',
        group_name: '',
        party_size: 1,
        table_id: ''
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit(formData);
      };

      return (
        <div className="qr-modal" onClick={onClose}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="font-serif text-3xl font-bold text-primary mb-6">Add Guest</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-primary mb-2">Name *</label>
                <input
                  type="text"
                  required
                  className="input-field"
                  placeholder="John Smith"
                  value={formData.name}
                  onChange={e => setFormData({ ...formData, name: e.target.value })}
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">Email</label>
                  <input
                    type="email"
                    className="input-field"
                    placeholder="john@email.com"
                    value={formData.email}
                    onChange={e => setFormData({ ...formData, email: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">Phone</label>
                  <input
                    type="tel"
                    className="input-field"
                    placeholder="+60123456789"
                    value={formData.phone}
                    onChange={e => setFormData({ ...formData, phone: e.target.value })}
                  />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">Group</label>
                  <input
                    type="text"
                    className="input-field"
                    placeholder="Family, Friends, etc."
                    value={formData.group_name}
                    onChange={e => setFormData({ ...formData, group_name: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">Party Size</label>
                  <input
                    type="number"
                    min="1"
                    className="input-field"
                    value={formData.party_size}
                    onChange={e => setFormData({ ...formData, party_size: parseInt(e.target.value) })}
                  />
                </div>
              </div>
              <div>
                <label className="block text-sm font-semibold text-primary mb-2">Assign Table</label>
                <select
                  className="input-field"
                  value={formData.table_id}
                  onChange={e => setFormData({ ...formData, table_id: e.target.value })}
                >
                  <option value="">Select later</option>
                  {tables.map(table => (
                    <option key={table.id} value={table.id}>
                      {table.table_name} ({table.seats_occupied}/{table.capacity} seats)
                    </option>
                  ))}
                </select>
              </div>
              <div className="flex space-x-3 pt-4">
                <button type="submit" className="btn-primary flex-1">Add Guest</button>
                <button type="button" onClick={onClose} className="btn-secondary flex-1">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // QR Code Modal
    function QRCodeModal({ guest, onClose }) {
      const qrRef = useRef(null);
      const guestUrl = `${GUEST_BASE_URL}${guest.qr_code}`;

      useEffect(() => {
        if (qrRef.current && !qrRef.current.hasChildNodes()) {
          // Clear any existing QR code
          qrRef.current.innerHTML = '';
          
          // Generate QR code
          new QRCode(qrRef.current, {
            text: guestUrl,
            width: 300,
            height: 300,
            colorDark: '#2c1810',
            colorLight: '#faf8f5',
            correctLevel: QRCode.CorrectLevel.H
          });
        }
      }, [guestUrl]);

      const handleDownload = () => {
        const canvas = qrRef.current.querySelector('canvas');
        if (canvas) {
          const url = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.download = `qr-${guest.name.replace(/\s+/g, '-')}.png`;
          link.href = url;
          link.click();
        }
      };

      return (
        <div className="qr-modal" onClick={onClose}>
          <div className="modal-content text-center" onClick={e => e.stopPropagation()}>
            <h3 className="font-serif text-3xl font-bold text-primary mb-2">{guest.name}</h3>
            <p className="text-secondary mb-6">
              {guest.group_name && `${guest.group_name} ‚Ä¢ `}
              Party of {guest.party_size}
              {guest.table_name && ` ‚Ä¢ Table ${guest.table_name}`}
            </p>
            <div className="bg-white p-4 rounded-xl border-2 border-accent inline-block mb-6">
              <div ref={qrRef}></div>
            </div>
            <p className="text-sm text-secondary mb-6 break-all">{guestUrl}</p>
            <div className="flex space-x-3">
              <button onClick={handleDownload} className="btn-primary flex-1">
                Download QR Code
              </button>
              <button onClick={onClose} className="btn-secondary flex-1">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Guest View Component (Demo)
    function GuestViewDemo() {
      const [qrCode, setQrCode] = useState('');
      const [guestData, setGuestData] = useState(null);
      const [layout, setLayout] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleLookup = async () => {
        if (!qrCode.trim()) return;
        
        setLoading(true);
        setError('');
        
        try {
          const [guestRes, layoutRes] = await Promise.all([
            fetch(`${API_BASE}/guest/${qrCode}`),
            fetch(`${API_BASE}/guest/${qrCode}/layout`)
          ]);

          if (!guestRes.ok) {
            throw new Error('Invalid QR code');
          }

          setGuestData(await guestRes.json());
          setLayout(await layoutRes.json());
        } catch (err) {
          setError(err.message);
          setGuestData(null);
          setLayout(null);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen pattern-bg py-12">
          <div className="max-w-2xl mx-auto px-4">
            <div className="text-center mb-8">
              <h2 className="font-serif text-4xl font-bold text-primary mb-2">Guest View Demo</h2>
              <p className="text-secondary">Test the guest QR code experience</p>
            </div>

            <div className="glass rounded-xl p-6 mb-6">
              <label className="block text-sm font-semibold text-primary mb-2">Enter QR Code</label>
              <div className="flex space-x-3">
                <input
                  type="text"
                  className="input-field flex-1"
                  placeholder="Paste QR code here"
                  value={qrCode}
                  onChange={e => setQrCode(e.target.value)}
                  onKeyPress={e => e.key === 'Enter' && handleLookup()}
                />
                <button onClick={handleLookup} className="btn-primary" disabled={loading}>
                  {loading ? 'Loading...' : 'View'}
                </button>
              </div>
              {error && <p className="text-red-500 text-sm mt-2">‚ùå {error}</p>}
            </div>

            {guestData && (
              <GuestView guestData={guestData} layout={layout} />
            )}
          </div>
        </div>
      );
    }

    // Guest View Component (Actual View)
    function GuestView({ guestData, layout }) {
      return (
        <div className="glass rounded-xl overflow-hidden">
          {/* Header */}
          <div className="gradient-primary text-white p-8 text-center">
            <div className="text-5xl mb-3">üéâ</div>
            <h1 className="font-serif text-3xl font-bold mb-2">{guestData.event_name}</h1>
            <p className="text-white/80">
              üìÖ {new Date(guestData.event_date).toLocaleDateString()}
            </p>
            <p className="text-white/80">üìç {guestData.event_venue}</p>
          </div>

          {/* Guest Info */}
          <div className="p-8 border-b border-border">
            <div className="text-center">
              <h2 className="font-serif text-3xl font-bold text-primary mb-2">Welcome!</h2>
              <p className="text-xl text-secondary mb-1">üë§ {guestData.name}</p>
              {guestData.group_name && (
                <p className="text-secondary">Group: {guestData.group_name}</p>
              )}
              <p className="text-secondary">Party Size: {guestData.party_size}</p>
            </div>
          </div>

          {/* Table Assignment */}
          {guestData.table_name ? (
            <>
              <div className="p-8 text-center">
                <p className="text-secondary mb-3">Your Assigned Table</p>
                <div className="inline-block bg-accent text-primary rounded-2xl px-12 py-8">
                  <div className="text-6xl font-bold font-serif">{guestData.table_name}</div>
                </div>
              </div>

              {/* Hall Layout */}
              {layout && layout.tables && (
                <div className="p-8 bg-gray-50">
                  <h3 className="font-serif text-2xl font-bold text-primary mb-4 text-center">Hall Layout</h3>
                  <div className="bg-white rounded-xl border-2 border-border p-4 relative h-96 overflow-hidden">
                    {layout.tables.map(table => (
                      <div
                        key={table.id}
                        className={`absolute rounded-lg p-3 text-center ${
                          table.id === layout.guestTableId
                            ? 'bg-accent text-primary font-bold shadow-lg scale-110'
                            : 'bg-gray-100 text-secondary'
                        }`}
                        style={{
                          left: `${(table.position_x / 800) * 100}%`,
                          top: `${(table.position_y / 600) * 100}%`,
                          width: '60px',
                          height: '60px',
                          transform: table.id === layout.guestTableId ? 'scale(1.1)' : 'scale(1)'
                        }}
                      >
                        <div className="text-sm font-bold">{table.table_name}</div>
                      </div>
                    ))}
                  </div>
                  <p className="text-center text-secondary mt-4">
                    ‚≠ê Your table is highlighted in gold
                  </p>
                </div>
              )}
            </>
          ) : (
            <div className="p-8 text-center">
              <div className="text-6xl mb-4">‚è≥</div>
              <h3 className="font-serif text-2xl font-bold text-primary mb-2">Table Assignment Pending</h3>
              <p className="text-secondary">Your table will be assigned soon. Please check back later.</p>
            </div>
          )}
        </div>
      );
    }

    // Guest View from QR Code
    function GuestViewFromQR({ qrCode }) {
      const [guestData, setGuestData] = useState(null);
      const [layout, setLayout] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');

      useEffect(() => {
        const fetchGuestData = async () => {
          try {
            const [guestRes, layoutRes] = await Promise.all([
              fetch(`${API_BASE}/guest/${qrCode}`),
              fetch(`${API_BASE}/guest/${qrCode}/layout`)
            ]);

            if (!guestRes.ok) {
              throw new Error('Invalid QR code');
            }

            setGuestData(await guestRes.json());
            setLayout(await layoutRes.json());
          } catch (err) {
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };

        fetchGuestData();
      }, [qrCode]);

      if (loading) {
        return (
          <div className="min-h-screen pattern-bg flex items-center justify-center">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-secondary">Loading your invitation...</p>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="min-h-screen pattern-bg flex items-center justify-center p-4">
            <div className="glass rounded-xl p-8 max-w-md text-center">
              <div className="text-6xl mb-4">‚ùå</div>
              <h2 className="font-serif text-3xl font-bold text-primary mb-2">Invalid QR Code</h2>
              <p className="text-secondary mb-6">{error}</p>
              <p className="text-sm text-secondary">Please contact the event organizer if you believe this is an error.</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen pattern-bg py-8 px-4">
          <div className="max-w-2xl mx-auto">
            <GuestView guestData={guestData} layout={layout} />
          </div>
        </div>
      );
    }

    // Main App Component
    function App() {
      const [currentView, setCurrentView] = useState('events');
      const [selectedEventId, setSelectedEventId] = useState(null);
      const [showCreateEvent, setShowCreateEvent] = useState(false);
      const [guestQRCode, setGuestQRCode] = useState(null);

      // Check URL for guest QR code on mount
      useEffect(() => {
        const checkHash = () => {
          const hash = window.location.hash;
          const guestMatch = hash.match(/^#\/guest\/([a-f0-9-]+)$/i);
          
          if (guestMatch) {
            setGuestQRCode(guestMatch[1]);
            setCurrentView('guest');
          }
        };

        checkHash();
        window.addEventListener('hashchange', checkHash);
        
        return () => window.removeEventListener('hashchange', checkHash);
      }, []);

      const handleSelectEvent = (eventId) => {
        setSelectedEventId(eventId);
        setCurrentView('dashboard');
      };

      const handleCreateEvent = (eventId) => {
        setShowCreateEvent(false);
        handleSelectEvent(eventId);
      };

      // If viewing guest page, don't show navigation
      if (currentView === 'guest' && guestQRCode) {
        return <GuestViewFromQR qrCode={guestQRCode} />;
      }

      return (
        <div className="min-h-screen">
          <Navigation currentView={currentView} onNavigate={setCurrentView} />
          
          {currentView === 'events' && (
            <EventsList
              onSelectEvent={handleSelectEvent}
              onCreateEvent={() => setShowCreateEvent(true)}
            />
          )}

          {currentView === 'dashboard' && selectedEventId && (
            <EventDashboard
              eventId={selectedEventId}
              onBack={() => setCurrentView('events')}
            />
          )}

          {currentView === 'demo' && <GuestViewDemo />}

          {showCreateEvent && (
            <CreateEventModal
              onClose={() => setShowCreateEvent(false)}
              onSuccess={handleCreateEvent}
            />
          )}
        </div>
      );
    }

    // Render App
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>