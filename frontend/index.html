<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Table Management System</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #2c1810;
        --secondary: #8b6f47;
        --accent: #d4af37;
        --bg-light: #faf8f5;
        --bg-dark: #1a1410;
        --text-dark: #2c1810;
        --text-light: #f5f5f5;
        --border: #e8dfd0;
      }

      body {
        font-family: "Outfit", sans-serif;
        background: var(--bg-light);
        color: var(--text-dark);
        overflow-x: hidden;
      }

      .font-serif {
        font-family: "Cormorant Garamond", serif;
      }

      .gradient-primary {
        background: linear-gradient(135deg, #2c1810 0%, #4a3425 100%);
      }

      .gradient-accent {
        background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      }

      .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(212, 175, 55, 0.2);
      }

      .table-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .table-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(212, 175, 55, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .table-card:hover::before {
        left: 100%;
      }

      .table-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(44, 24, 16, 0.15);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
      }

      .pattern-bg {
        background-image:
          linear-gradient(rgba(212, 175, 55, 0.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(212, 175, 55, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
      }

      .btn-primary {
        background: var(--accent);
        color: var(--primary);
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
      }

      .btn-primary:hover {
        background: #f4d03f;
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(212, 175, 55, 0.3);
      }

      .btn-secondary {
        background: white;
        color: var(--primary);
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        border: 2px solid var(--border);
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-secondary:hover {
        border-color: var(--accent);
        background: var(--bg-light);
      }

      input,
      select,
      textarea {
        font-family: "Outfit", sans-serif;
      }

      .input-field {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s;
        background: white;
      }

      .input-field:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
      }

      /*.draggable-table {
      position: absolute;
      cursor: move;
      user-select: none;
      transition: box-shadow 0.2s;
    }

    .draggable-table:active {
      cursor: grabbing;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }*/

      .draggable-table {
        position: absolute;
        cursor: move;
        user-select: none;
        transition: all 0.2s;
        z-index: 1;

        /* NEW - Make tables round */
        border-radius: 50%;
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background: white;
        border: 3px solid var(--accent);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .draggable-table:hover {
        box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
        transform: scale(1.05);
      }

      .draggable-table.selected {
        border-color: #ff6b6b;
        box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.2);
      }

      .table-delete-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #ef4444;
        color: white;
        border: 2px solid white;
        font-size: 12px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transform: scale(0.6);
        transition: opacity 0.15s, transform 0.15s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        z-index: 10;
      }

      .draggable-table:hover .table-delete-btn {
        opacity: 1;
        transform: scale(1);
      }

      .table-delete-btn:hover {
        background: #b91c1c;
        transform: scale(1.15) !important;
      }

      .table-edit-btn {
        position: absolute;
        top: -8px;
        left: -8px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        border: 2px solid white;
        font-size: 11px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transform: scale(0.6);
        transition: opacity 0.15s, transform 0.15s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        z-index: 10;
      }

      .draggable-table:hover .table-edit-btn {
        opacity: 1;
        transform: scale(1);
      }

      .table-edit-btn:hover {
        background: #1d4ed8;
        transform: scale(1.15) !important;
      }

      /* Layout Icons */
      .layout-icon {
        position: absolute;
        cursor: move;
        user-select: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        z-index: 2;
        z-index: 5;
        transition: filter 0.15s;
      }
      .layout-icon:hover { filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25)); }
      .layout-icon-emoji { font-size: 32px; line-height: 1; }
      .layout-icon-label {
        font-size: 10px;
        font-weight: 600;
        color: #4a4a4a;
        background: rgba(255,255,255,0.85);
        border-radius: 4px;
        padding: 1px 4px;
        white-space: nowrap;
      }
      .icon-remove-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #ef4444;
        color: white;
        border: 2px solid white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transform: scale(0.6);
        transition: opacity 0.15s, transform 0.15s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 10;
      }
      .layout-icon:hover .icon-remove-btn { opacity: 1; transform: scale(1); }
      .icon-remove-btn:hover { background: #b91c1c; transform: scale(1.15) !important; }

      /* Icon palette toolbar */
      .icon-palette {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 10px 14px;
        background: rgba(255,255,255,0.95);
        border: 1px solid rgba(212,175,55,0.35);
        border-radius: 10px;
        margin-bottom: 10px;
        align-items: center;
      }
      .icon-palette-label { font-size: 12px; font-weight: 600; color: #888; margin-right: 4px; }
      .icon-palette-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid rgba(212,175,55,0.3);
        background: white;
        cursor: pointer;
        transition: all 0.15s;
        font-size: 11px;
        color: #555;
      }
      .icon-palette-btn:hover { background: rgba(212,175,55,0.12); border-color: var(--accent); transform: translateY(-2px); }
      .icon-palette-btn span:first-child { font-size: 20px; }

      /* Table detail panel */
      .table-detail-panel {
        position: absolute;
        top: 0;
        right: 0;
        width: 260px;
        height: 100%;
        background: rgba(255,255,255,0.97);
        border-left: 2px solid rgba(212,175,55,0.3);
        border-radius: 0 12px 12px 0;
        display: flex;
        flex-direction: column;
        z-index: 20;
        box-shadow: -4px 0 16px rgba(0,0,0,0.08);
        overflow-y: auto;
      }
      .table-detail-header {
        padding: 14px 14px 10px;
        border-bottom: 1px solid rgba(212,175,55,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
      }
      .table-detail-close {
        width: 24px; height: 24px; border-radius: 50%;
        background: #f3f4f6; border: none; cursor: pointer;
        font-size: 13px; display: flex; align-items: center; justify-content: center;
        color: #666; transition: background 0.15s;
      }
      .table-detail-close:hover { background: #e5e7eb; }
      .seat-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 13px;
      }
      .seat-number {
        width: 24px; height: 24px; border-radius: 50%;
        background: rgba(212,175,55,0.15);
        border: 1px solid rgba(212,175,55,0.4);
        display: flex; align-items: center; justify-content: center;
        font-size: 11px; font-weight: 700; color: #7a6520;
        flex-shrink: 0;
      }
      .seat-row select { flex: 1; font-size: 12px; padding: 3px 6px; border-radius: 6px; border: 1px solid #d1d5db; }

      /* Seats around table circle */
      .seat-around {
        position: absolute;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        font-weight: 700;
        border: 2px solid white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        pointer-events: none;
        z-index: 6;
        transition: background 0.2s;
      }
      .seat-around.empty { background: #e5e7eb; color: #666; }
      .seat-around.occupied { background: #d4af37; color: white; }

      /*.canvas-container {
        position: relative;
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background-image: radial-gradient(
          circle at 20px 20px,
          rgba(212, 175, 55, 0.05) 1px,
          transparent 1px
        );
        background-size: 40px 40px;
      }*/

      .canvas-container {
        position: relative;
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        overflow: hidden;

        /* NEW - Add grid */
        background-image:
          linear-gradient(rgba(212, 175, 55, 0.1) 1px, transparent 1px),
          linear-gradient(90deg, rgba(212, 175, 55, 0.1) 1px, transparent 1px);
        background-size: 40px 40px;
      }

      .qr-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        animation: fadeInUp 0.3s ease-out;
      }

      .stat-card {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s;
      }

      .stat-card:hover {
        border-color: var(--accent);
        box-shadow: 0 10px 30px rgba(212, 175, 55, 0.1);
      }

      .guest-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s;
      }

      .guest-card:hover {
        border-color: var(--accent);
        background: var(--bg-light);
      }

      @media (max-width: 768px) {
        .btn-primary,
        .btn-secondary {
          padding: 0.625rem 1.25rem;
          font-size: 0.8125rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Configuration ‚Äî auto-detect local vs production
      const API_BASE = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
        ? "http://localhost:3001/api"
        : "https://table-management-system-kagg.onrender.com/api";
      const GUEST_BASE_URL =
        window.location.origin + window.location.pathname + "#/guest/";

      // ==================== COMPONENTS ====================

      // Navigation Component
      function Navigation({ currentView, onNavigate }) {
        return (
          <nav className="gradient-primary text-white shadow-lg">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center h-16">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 rounded-full bg-accent flex items-center justify-center">
                    <span className="text-2xl">üé™</span>
                  </div>
                  <h1 className="font-serif text-2xl font-bold tracking-wide">
                    Table Manager
                  </h1>
                </div>
                <div className="flex space-x-4">
                  <button
                    onClick={() => onNavigate("events")}
                    className={`px-4 py-2 rounded-lg transition-all ${
                      currentView === "events"
                        ? "bg-accent text-primary font-semibold"
                        : "hover:bg-white/10"
                    }`}
                  >
                    Events
                  </button>
                  <button
                    onClick={() => onNavigate("demo")}
                    className={`px-4 py-2 rounded-lg transition-all ${
                      currentView === "demo"
                        ? "bg-accent text-primary font-semibold"
                        : "hover:bg-white/10"
                    }`}
                  >
                    Guest Demo
                  </button>
                </div>
              </div>
            </div>
          </nav>
        );
      }

      // Events List Component
      function EventsList({ onSelectEvent, onCreateEvent }) {
        const [events, setEvents] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          fetchEvents();
        }, []);

        const fetchEvents = async () => {
          try {
            const response = await fetch(`${API_BASE}/events`);
            const data = await response.json();
            setEvents(data);
          } catch (error) {
            console.error("Error fetching events:", error);
          } finally {
            setLoading(false);
          }
        };


        if (loading) {
          return (
            <div className="flex justify-center items-center h-96">
              <div className="text-center">
                <div className="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p className="text-secondary">Loading events...</p>
              </div>
            </div>
          );
        }

        return (
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 pattern-bg">
            <div className="flex justify-between items-center mb-8 animate-fade-in-up">
              <div>
                <h2 className="font-serif text-4xl font-bold text-primary mb-2">
                  Your Events
                </h2>
                <p className="text-secondary text-lg">
                  Manage wedding dinners, banquets, and celebrations
                </p>
              </div>
              <button onClick={onCreateEvent} className="btn-primary">
                ‚ú® Create Event
              </button>
            </div>

            {events.length === 0 ? (
              <div
                className="text-center py-20 animate-fade-in-up"
                style={{ animationDelay: "0.1s" }}
              >
                <div className="text-8xl mb-6">üéâ</div>
                <h3 className="font-serif text-3xl font-bold text-primary mb-3">
                  No events yet
                </h3>
                <p className="text-secondary text-lg mb-6">
                  Create your first event to start managing tables and guests
                </p>
                <button onClick={onCreateEvent} className="btn-primary">
                  Create Your First Event
                </button>
              </div>
            ) : (
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                {events.map((event, index) => (
                  <div
                    key={event.id}
                    onClick={() => onSelectEvent(event.id)}
                    className="table-card glass rounded-xl p-6 animate-fade-in-up"
                    style={{ animationDelay: `${index * 0.1}s` }}
                  >
                    <div className="flex items-start justify-between mb-4">
                      <div className="w-12 h-12 rounded-full gradient-accent flex items-center justify-center text-2xl">
                        üéä
                      </div>
                      <span className="text-xs text-secondary bg-accent/10 px-3 py-1 rounded-full">
                        {new Date(event.date).toLocaleDateString()}
                      </span>
                    </div>
                    <h3 className="font-serif text-2xl font-bold text-primary mb-2">
                      {event.name}
                    </h3>
                    <p className="text-secondary mb-4">
                      üìç {event.venue || "Venue TBC"}
                    </p>
                    <div className="flex items-center justify-between pt-4 border-t border-border">
                      <span className="text-sm text-secondary">
                        View Details
                      </span>
                      <span className="text-accent text-xl">‚Üí</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      // Create Event Modal
      function CreateEventModal({ onClose, onSuccess }) {
        const [formData, setFormData] = useState({
          name: "",
          date: "",
          start_time: "",
          end_time: "",
          venue: "",
        });

        const handleSubmit = async (e) => {
          e.preventDefault();
          try {
            const response = await fetch(`${API_BASE}/events`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });
            const data = await response.json();
            onSuccess(data.id);
          } catch (error) {
            console.error("Error creating event:", error);
          }
        };

        return (
          <div className="qr-modal" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <h3 className="font-serif text-3xl font-bold text-primary mb-6">
                Create New Event
              </h3>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Event Name *
                  </label>
                  <input
                    type="text"
                    required
                    className="input-field"
                    placeholder="e.g., Sarah & John's Wedding"
                    value={formData.name}
                    onChange={(e) =>
                      setFormData({ ...formData, name: e.target.value })
                    }
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Date *
                  </label>
                  <input
                    type="date"
                    required
                    className="input-field"
                    value={formData.date}
                    onChange={(e) =>
                      setFormData({ ...formData, date: e.target.value })
                    }
                  />
                </div>
                <div className="flex space-x-3">
                  <div className="flex-1">
                    <label className="block text-sm font-semibold text-primary mb-2">
                      Start Time
                    </label>
                    <input
                      type="time"
                      className="input-field"
                      value={formData.start_time}
                      onChange={(e) =>
                        setFormData({ ...formData, start_time: e.target.value })
                      }
                    />
                  </div>
                  <div className="flex-1">
                    <label className="block text-sm font-semibold text-primary mb-2">
                      End Time
                    </label>
                    <input
                      type="time"
                      className="input-field"
                      value={formData.end_time}
                      onChange={(e) =>
                        setFormData({ ...formData, end_time: e.target.value })
                      }
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Venue
                  </label>
                  <input
                    type="text"
                    className="input-field"
                    placeholder="e.g., Grand Ballroom, Hotel Continental"
                    value={formData.venue}
                    onChange={(e) =>
                      setFormData({ ...formData, venue: e.target.value })
                    }
                  />
                </div>
                <div className="flex space-x-3 pt-4">
                  <button type="submit" className="btn-primary flex-1">
                    Create Event
                  </button>
                  <button
                    type="button"
                    onClick={onClose}
                    className="btn-secondary flex-1"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      // Edit Event Modal
      function EditEventModal({ event, onClose, onSuccess }) {
        const [formData, setFormData] = useState({
          name: event.name || "",
          date: event.date || "",
          start_time: event.start_time || "",
          end_time: event.end_time || "",
          venue: event.venue || "",
        });

        const handleSubmit = async (e) => {
          e.preventDefault();
          try {
            const res = await fetch(`${API_BASE}/events/${event.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });
            const data = await res.json();
            onSuccess(data.event);
          } catch (error) {
            console.error("Error updating event:", error);
          }
        };

        return (
          <div className="qr-modal" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <h3 className="font-serif text-3xl font-bold text-primary mb-6">Edit Event</h3>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">Event Name *</label>
                  <input type="text" required className="input-field" value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })} />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">Date *</label>
                  <input type="date" required className="input-field" value={formData.date}
                    onChange={(e) => setFormData({ ...formData, date: e.target.value })} />
                </div>
                <div className="flex space-x-3">
                  <div className="flex-1">
                    <label className="block text-sm font-semibold text-primary mb-2">Start Time</label>
                    <input type="time" className="input-field" value={formData.start_time}
                      onChange={(e) => setFormData({ ...formData, start_time: e.target.value })} />
                  </div>
                  <div className="flex-1">
                    <label className="block text-sm font-semibold text-primary mb-2">End Time</label>
                    <input type="time" className="input-field" value={formData.end_time}
                      onChange={(e) => setFormData({ ...formData, end_time: e.target.value })} />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">Venue</label>
                  <input type="text" className="input-field" value={formData.venue}
                    onChange={(e) => setFormData({ ...formData, venue: e.target.value })} />
                </div>
                <div className="flex space-x-3 pt-4">
                  <button type="submit" className="btn-primary flex-1">Save Changes</button>
                  <button type="button" onClick={onClose} className="btn-secondary flex-1">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      // Event Dashboard Component
      function EventDashboard({ eventId, onBack }) {
        const [event, setEvent] = useState(null);
        const [tables, setTables] = useState([]);
        const [guests, setGuests] = useState([]);
        const [icons, setIcons] = useState([]);
        const [activeTab, setActiveTab] = useState("overview");
        const [showCreateTable, setShowCreateTable] = useState(false);
        const [showAddGuest, setShowAddGuest] = useState(false);
        const [selectedGuest, setSelectedGuest] = useState(null);
        const [showEditEvent, setShowEditEvent] = useState(false);

        useEffect(() => {
          fetchEventData();
        }, [eventId]);

        const fetchEventData = async () => {
          try {
            const [eventRes, tablesRes, guestsRes, iconsRes] = await Promise.all([
              fetch(`${API_BASE}/events/${eventId}`),
              fetch(`${API_BASE}/events/${eventId}/tables`),
              fetch(`${API_BASE}/events/${eventId}/guests`),
              fetch(`${API_BASE}/events/${eventId}/icons`),
            ]);
            if (eventRes.ok) setEvent(await eventRes.json());
            if (tablesRes.ok) setTables(await tablesRes.json());
            if (guestsRes.ok) setGuests(await guestsRes.json());
            if (iconsRes.ok) setIcons(await iconsRes.json());
          } catch (error) {
            console.error("Error fetching event data:", error);
          }
        };

        if (!event) {
          return (
            <div className="flex justify-center items-center h-96">
              <div className="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
            </div>
          );
        }

        return (
          <div className="min-h-screen pattern-bg">
            {/* Header */}
            <div className="gradient-primary text-white shadow-lg">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <button
                  onClick={onBack}
                  className="mb-4 text-accent hover:text-white transition-colors flex items-center space-x-2"
                >
                  <span>‚Üê</span>
                  <span>Back to Events</span>
                </button>
                <div className="flex justify-between items-start">
                  <div>
                    <h1 className="font-serif text-4xl font-bold mb-2">
                      {event.name}
                    </h1>
                    <p className="text-white/80 text-lg">
                      üìÖ {new Date(event.date).toLocaleDateString()}
                      {(event.start_time || event.end_time) && (
                        <span>
                          {" "}‚Ä¢{" "}
                          üïê{" "}
                          {event.start_time && event.end_time
                            ? `${event.start_time} ‚Äì ${event.end_time}`
                            : event.start_time || event.end_time}
                        </span>
                      )}
                      {" "}‚Ä¢ üìç {event.venue || "Venue TBC"}
                    </p>
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setShowEditEvent(true)}
                      className="btn-secondary"
                      style={{ whiteSpace: "nowrap" }}
                    >
                      ‚úèÔ∏è Edit Event
                    </button>
                    <button
                      onClick={async () => {
                        if (!window.confirm(`Delete "${event.name}"? This will remove all tables, guests, and data for this event.`)) return;
                        try {
                          await fetch(`${API_BASE}/events/${eventId}`, { method: "DELETE" });
                          onBack();
                        } catch (error) {
                          console.error("Error deleting event:", error);
                        }
                      }}
                      className="btn-secondary"
                      style={{ whiteSpace: "nowrap", color: "#ef4444" }}
                    >
                      üóë Delete Event
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Stats Cards */}
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-6 mb-8">
              <div className="grid md:grid-cols-4 gap-4">
                <div className="stat-card">
                  <div className="text-3xl mb-2">üéØ</div>
                  <div className="text-2xl font-bold text-primary">
                    {event.stats?.totalTables || 0}
                  </div>
                  <div className="text-sm text-secondary">Total Tables</div>
                </div>
                <div className="stat-card">
                  <div className="text-3xl mb-2">üí∫</div>
                  <div className="text-2xl font-bold text-primary">
                    {event.stats?.totalSeats || 0}
                  </div>
                  <div className="text-sm text-secondary">Total Seats</div>
                </div>
                <div className="stat-card">
                  <div className="text-3xl mb-2">üë•</div>
                  <div className="text-2xl font-bold text-primary">
                    {event.stats?.assignedGuests || 0}
                  </div>
                  <div className="text-sm text-secondary">Guests Assigned</div>
                </div>
                <div className="stat-card">
                  <div className="text-3xl mb-2">‚ú®</div>
                  <div className="text-2xl font-bold text-primary">
                    {event.stats?.remainingSeats || 0}
                  </div>
                  <div className="text-sm text-secondary">Seats Remaining</div>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
              <div className="bg-white rounded-xl border-2 border-border p-2 inline-flex space-x-2">
                {["overview", "tables", "guests"].map((tab) => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`px-6 py-2 rounded-lg font-semibold transition-all capitalize ${
                      activeTab === tab
                        ? "bg-accent text-primary shadow-md"
                        : "text-secondary hover:bg-gray-50"
                    }`}
                  >
                    {tab}
                  </button>
                ))}
              </div>
            </div>

            {/* Content */}
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
              {activeTab === "overview" && (
                <OverviewTab event={event} tables={tables} guests={guests} />
              )}
              {activeTab === "tables" && (
                <TablesTab
                  eventId={eventId}
                  event={event}
                  tables={tables}
                  setTables={setTables}
                  guests={guests}
                  icons={icons}
                  setIcons={setIcons}
                  onRefresh={fetchEventData}
                />
              )}
              {activeTab === "guests" && (
                <GuestsTab
                  eventId={eventId}
                  guests={guests}
                  tables={tables}
                  onRefresh={fetchEventData}
                />
              )}
            </div>

            {showEditEvent && (
              <EditEventModal
                event={event}
                onClose={() => setShowEditEvent(false)}
                onSuccess={(updated) => { setEvent(updated); setShowEditEvent(false); }}
              />
            )}
          </div>
        );
      }

      // Overview Tab
      function OverviewTab({ event, tables, guests }) {
        return (
          <div className="space-y-8">
            <div className="glass rounded-xl p-8">
              <h3 className="font-serif text-2xl font-bold text-primary mb-6">
                Event Summary
              </h3>
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <h4 className="font-semibold text-primary mb-3">
                    Quick Stats
                  </h4>
                  <ul className="space-y-2 text-secondary">
                    <li>‚Ä¢ {tables.length} tables configured</li>
                    <li>‚Ä¢ {guests.length} guest groups registered</li>
                    <li>
                      ‚Ä¢ {guests.filter((g) => g.table_id).length} groups
                      assigned to tables
                    </li>
                    <li>
                      ‚Ä¢ {guests.filter((g) => !g.table_id).length} groups
                      pending assignment
                    </li>
                  </ul>
                </div>
                <div>
                  <h4 className="font-semibold text-primary mb-3">
                    Next Steps
                  </h4>
                  <ul className="space-y-2 text-secondary">
                    <li>‚úì Configure table layout in Tables tab</li>
                    <li>‚úì Add all guests in Guests tab</li>
                    <li>‚úì Assign guests to tables</li>
                    <li>‚úì Generate and distribute QR codes</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Helper: returns a Set of active sides ('top','bottom','left','right') for a rectangle table
      // seat_sides_config (new): comma-separated string e.g. "top,bottom"
      // seat_sides (legacy): integer count 1-4 (top / top+bottom / top+bottom+left / all)
      function parseSeatSides(table) {
        if (table.seat_sides_config) {
          return new Set(table.seat_sides_config.split(',').filter(Boolean));
        }
        const count = parseInt(table.seat_sides) || 2;
        const s = new Set();
        if (count >= 1) s.add('top');
        if (count >= 2) s.add('bottom');
        if (count >= 3) s.add('left');
        if (count >= 4) s.add('right');
        return s;
      }

      // Available layout icons
      const LAYOUT_ICONS = [
        { type: "entrance", emoji: "üö™", label: "Entrance" },
        { type: "stage", emoji: "üé≠", label: "Stage" },
        { type: "dj", emoji: "üé§", label: "DJ / Band" },
        { type: "buffet", emoji: "üçΩÔ∏è", label: "Buffet" },
        { type: "cake", emoji: "üéÇ", label: "Cake" },
        { type: "photo", emoji: "üì∏", label: "Photo Booth" },
        { type: "restroom", emoji: "üöª", label: "Restroom" },
        { type: "flowers", emoji: "üíê", label: "Flowers" },
        { type: "bar", emoji: "üç∑", label: "Bar" },
        { type: "parking", emoji: "üÖøÔ∏è", label: "Parking" },
      ];

      // Tables Tab
      function TablesTab({ eventId, event, tables, setTables, guests, icons, setIcons, onRefresh }) {
        const [showCreateModal, setShowCreateModal] = useState(false);
        const [selectedTable, setSelectedTable] = useState(null);

        // Venue layout background image
        const [layoutImage, setLayoutImage] = React.useState(event?.layout_image || null);
        const [imageOpacity, setImageOpacity] = React.useState(40);
        const layoutImageInputRef = React.useRef(null);

        // Sync when event prop changes (e.g. after onRefresh)
        React.useEffect(() => {
          setLayoutImage(event?.layout_image || null);
        }, [event?.layout_image]);

        const handleLayoutImageUpload = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (ev) => {
            const dataUrl = ev.target.result;
            setLayoutImage(dataUrl);
            try {
              await fetch(`${API_BASE}/events/${eventId}/layout-image`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ layout_image: dataUrl }),
              });
            } catch (err) { console.error("Failed to save layout image", err); }
          };
          reader.readAsDataURL(file);
          e.target.value = "";
        };

        const handleRemoveLayoutImage = async () => {
          setLayoutImage(null);
          try {
            await fetch(`${API_BASE}/events/${eventId}/layout-image`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ layout_image: null }),
            });
          } catch (err) { console.error("Failed to remove layout image", err); }
        };
        const [tableNameEdit, setTableNameEdit] = useState("");
        const [capacityEdit, setCapacityEdit] = useState(1);
        const [shapeEdit, setShapeEdit] = useState("circle");
        const [purposeEdit, setPurposeEdit] = useState("dining table");
        const [colorEdit, setColorEdit] = useState("#ffffff");
        const [seatSidesConfigEdit, setSeatSidesConfigEdit] = useState("top,bottom");
        const [showSeatsEdit, setShowSeatsEdit] = useState(true);
        const [rotationEdit, setRotationEdit] = useState(0);
        const [clipboard, setClipboard] = useState(null);

        const handleShapeChange = (val) => {
          setShapeEdit(val);
          if (selectedTable) setTables(prev => prev.map(t => t.id === selectedTable.id ? { ...t, shape: val } : t));
        };
        const handlePurposeChange = (val) => {
          setPurposeEdit(val);
          if (selectedTable) {
            const updates = { purpose: val };
            if (val !== "dining table") {
              updates.capacity = 0;
              setCapacityEdit(0);
            }
            setTables(prev => prev.map(t => t.id === selectedTable.id ? { ...t, ...updates } : t));
          }
        };
        const handleColorChange = (val) => {
          setColorEdit(val);
          if (selectedTable) setTables(prev => prev.map(t => t.id === selectedTable.id ? { ...t, color: val } : t));
        };
        const handleSeatSidesConfigChange = (val) => {
          setSeatSidesConfigEdit(val);
          if (selectedTable) setTables(prev => prev.map(t => t.id === selectedTable.id ? { ...t, seat_sides_config: val } : t));
        };
        const handleShowSeatsChange = (val) => {
          setShowSeatsEdit(val);
          if (selectedTable) setTables(prev => prev.map(t => t.id === selectedTable.id ? { ...t, show_seats: val } : t));
        };
        const handleRotationChange = (val) => {
          setRotationEdit(val);
          if (selectedTable) setTables(prev => prev.map(t => t.id === selectedTable.id ? { ...t, rotation: val } : t));
        };
        // Called by TableDetailPanel after Done saves to DB ‚Äî only patches defined fields
        // (preserves computed fields like seats_occupied that aren't returned by PUT)
        const handleTableUpdate = (updatedTable) => {
          const patch = Object.fromEntries(
            Object.entries(updatedTable).filter(([, v]) => v !== undefined)
          );
          setTables(prev => prev.map(t => t.id !== updatedTable.id ? t : { ...t, ...patch }));
        };

        // Copy/paste helpers
        const handleCopy = () => {
          if (!selectedTable) return;
          const t = tables.find(tbl => tbl.id === selectedTable.id);
          if (t) setClipboard({ type: "table", data: { ...t } });
        };

        const getNextTableName = (templateName) => {
          const match = templateName.match(/^(.*?)(\d+)$/);
          if (!match) {
            const baseName = templateName;
            let counter = 2;
            while (tables.some(t => t.table_name === `${baseName} ${counter}`)) counter++;
            return `${baseName} ${counter}`;
          }
          const prefix = match[1];
          const nums = tables
            .map(t => { const m = t.table_name.match(/^(.*?)(\d+)$/); return (m && m[1] === prefix) ? parseInt(m[2]) : 0; })
            .filter(n => n > 0);
          const maxNum = nums.length > 0 ? Math.max(...nums) : 0;
          return `${prefix}${maxNum + 1}`;
        };

        const handlePaste = async () => {
          if (!clipboard || clipboard.type !== "table") return;
          const t = clipboard.data;
          const newName = getNextTableName(t.table_name);
          try {
            const createResp = await fetch(`${API_BASE}/events/${eventId}/tables`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ tables: [{ table_name: newName, capacity: t.capacity, shape: t.shape || "circle", purpose: t.purpose || "dining table", color: t.color || "#ffffff", seat_sides: t.seat_sides ?? 2, seat_sides_config: t.seat_sides_config || null, show_seats: t.show_seats ?? true }] }),
            });
            const createData = await createResp.json();
            const newTable = createData.tables?.[0];
            if (newTable) {
              const newX = Math.min((t.position_x || 0) + 30, layoutWidth - 100);
              const newY = Math.min((t.position_y || 0) + 30, layoutHeight - 80);
              await fetch(`${API_BASE}/tables/${newTable.id}/position`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ position_x: newX, position_y: newY }),
              });
              // Append to existing state ‚Äî do NOT overwrite (would lose other tables' local shapes)
              setTables(prev => [...prev, { ...newTable, position_x: newX, position_y: newY, seats_occupied: 0 }]);
            }
          } catch (err) {
            console.error("Error pasting:", err);
          }
        };
        const [saving, setSaving] = useState(false);
        const [layoutWidth, setLayoutWidth] = useState(() => parseInt(localStorage.getItem(`layout_w_${eventId}`)) || 1200);
        const [layoutHeight, setLayoutHeight] = useState(() => parseInt(localStorage.getItem(`layout_h_${eventId}`)) || 600);
        const [widthInput, setWidthInput] = useState(() => String(parseInt(localStorage.getItem(`layout_w_${eventId}`)) || 1200));
        const [heightInput, setHeightInput] = useState(() => String(parseInt(localStorage.getItem(`layout_h_${eventId}`)) || 600));

        const handleLayoutSize = (w, h) => {
          const nw = isNaN(w) ? layoutWidth : Math.max(400, w);
          const nh = isNaN(h) ? layoutHeight : Math.max(300, h);
          setLayoutWidth(nw);
          setLayoutHeight(nh);
          setWidthInput(String(nw));
          setHeightInput(String(nh));
          localStorage.setItem(`layout_w_${eventId}`, nw);
          localStorage.setItem(`layout_h_${eventId}`, nh);
        };
        const canvasRef = useRef(null);

        // Table drag
        const [draggedTable, setDraggedTable] = useState(null);
        const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
        const [tableDragMoved, setTableDragMoved] = useState(false);

        // Table resize
        const [resizingTable, setResizingTable] = useState(null); // { id, shape, startW, startH }
        const [resizeStartPos, setResizeStartPos] = useState(null); // { x, y }

        // Icon drag
        const [draggedIcon, setDraggedIcon] = useState(null);
        const [iconDragOffset, setIconDragOffset] = useState({ x: 0, y: 0 });
        const draggedIconCurrentPos = useRef(null);

        const handleCreateTables = async (tableData) => {
          try {
            const resp = await fetch(`${API_BASE}/events/${eventId}/tables`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ tables: tableData }),
            });
            const data = await resp.json();
            setShowCreateModal(false);
            // Add new tables to existing state without overwriting (avoids losing local shape changes)
            if (data.tables && data.tables.length > 0) {
              setTables(prev => [...prev, ...data.tables.map(t => ({ ...t, seats_occupied: 0 }))]);
            } else {
              onRefresh();
            }
          } catch (error) {
            console.error("Error creating tables:", error);
          }
        };

        const handleSaveChanges = async () => {
          setSaving(true);
          try {
            // Save ALL tables from current local state ‚Äî never use stale edit-state vars
            // (edit-state vars default to "circle" and would overwrite correct shapes)
            await Promise.all(
              tables.map((t) => Promise.all([
                fetch(`${API_BASE}/tables/${t.id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    table_name: t.table_name, capacity: t.capacity,
                    shape: t.shape || "circle", purpose: t.purpose || "dining table",
                    color: t.color || "#ffffff",
                    seat_sides: t.seat_sides ?? 2, seat_sides_config: t.seat_sides_config || null,
                    show_seats: t.show_seats ?? true,
                    width: t.width || null, height: t.height || null, rotation: t.rotation ?? 0,
                  }),
                }),
                fetch(`${API_BASE}/tables/${t.id}/position`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ position_x: t.position_x, position_y: t.position_y }),
                }),
              ]))
            );
            // Do NOT call onRefresh() ‚Äî local state already reflects the truth;
            // calling it would overwrite local shapes with potentially stale DB values
          } catch (error) {
            alert("Error saving layout");
          }
          setSaving(false);
        };

        const handlePositionChange = (tableId, x, y) => {
          setTables((prev) =>
            prev.map((t) => t.id === tableId ? { ...t, position_x: x, position_y: y } : t)
          );
        };

        const handleClearLayout = async () => {
          if (!window.confirm("Clear layout? This removes all objects (tables, stages, pillars, carpets, icons, etc.). Guests will be unassigned but not deleted.")) return;
          try {
            await fetch(`${API_BASE}/events/${eventId}/layout`, { method: "DELETE" });
            setSelectedTable(null);
            onRefresh();
          } catch (error) {
            alert("Error clearing layout");
          }
        };

        const handleDeleteTable = async (tableId, tableName) => {
          if (confirm(`Delete ${tableName}? This cannot be undone.`)) {
            try {
              await fetch(`${API_BASE}/tables/${tableId}`, { method: "DELETE" });
              if (selectedTable && selectedTable.id === tableId) setSelectedTable(null);
              onRefresh();
            } catch (error) {
              alert("Error deleting table");
            }
          }
        };

        // Table drag handlers
        const handleTableMouseDown = (e, table) => {
          const rect = e.currentTarget.getBoundingClientRect();
          setDragOffset({ x: e.clientX - rect.left, y: e.clientY - rect.top });
          setDraggedTable(table);
          setTableDragMoved(false);
        };

        const handleMouseMove = (e) => {
          if (!canvasRef.current) return;
          const canvas = canvasRef.current.getBoundingClientRect();

          if (resizingTable) {
            const dx = e.clientX - resizeStartPos.x;
            const dy = e.clientY - resizeStartPos.y;
            let newW, newH;
            if (resizingTable.shape === "circle") {
              const size = Math.max(40, resizingTable.startW + (dx + dy) / 2);
              newW = size; newH = size;
            } else {
              newW = Math.max(60, resizingTable.startW + dx);
              newH = Math.max(40, resizingTable.startH + dy);
            }
            setTables(prev => prev.map(t => t.id === resizingTable.id ? { ...t, width: Math.round(newW), height: Math.round(newH) } : t));
            return;
          }

          if (draggedTable) {
            setTableDragMoved(true);
            const t = tables.find(tbl => tbl.id === draggedTable.id);
            const tW = t?.width || (draggedTable.shape === "rectangle" ? 140 : 100);
            const tH = t?.height || (draggedTable.shape === "rectangle" ? 80 : 100);
            const x = Math.max(0, Math.min(canvas.width - tW, e.clientX - canvas.left - dragOffset.x));
            const y = Math.max(0, Math.min(canvas.height - tH, e.clientY - canvas.top - dragOffset.y));
            setTables((prev) => prev.map((t) => t.id === draggedTable.id ? { ...t, position_x: x, position_y: y } : t));
          }

          if (draggedIcon) {
            const x = Math.max(0, Math.min(canvas.width - 50, e.clientX - canvas.left - iconDragOffset.x));
            const y = Math.max(0, Math.min(canvas.height - 50, e.clientY - canvas.top - iconDragOffset.y));
            draggedIconCurrentPos.current = { x, y };
            setIcons((prev) => prev.map((ic) => ic.id === draggedIcon.id ? { ...ic, position_x: x, position_y: y } : ic));
          }
        };

        const handleMouseUp = async () => {
          // Resize end
          if (resizingTable) {
            const t = tables.find(tbl => tbl.id === resizingTable.id);
            if (t) {
              try {
                await fetch(`${API_BASE}/tables/${t.id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ table_name: t.table_name, capacity: t.capacity, shape: t.shape || "circle", purpose: t.purpose || "dining table", color: t.color || "#ffffff", seat_sides: t.seat_sides ?? 2, seat_sides_config: t.seat_sides_config || null, show_seats: t.show_seats ?? true, width: t.width, height: t.height, rotation: t.rotation ?? 0 }),
                });
              } catch (error) { console.error("Error saving resize:", error); }
            }
            setResizingTable(null);
            setResizeStartPos(null);
            return;
          }

          if (draggedTable) {
            if (!tableDragMoved) {
              // It was a click, not a drag ‚Üí open detail panel
              setSelectedTable(draggedTable);
              setTableNameEdit(draggedTable.table_name);
              setCapacityEdit(draggedTable.capacity);
              setShapeEdit(draggedTable.shape || "circle");
              setPurposeEdit(draggedTable.purpose || "dining table");
              setColorEdit(draggedTable.color || "#ffffff");
              setSeatSidesConfigEdit([...parseSeatSides(draggedTable)].join(',') || 'top');
              setShowSeatsEdit(draggedTable.show_seats ?? true);
              setRotationEdit(draggedTable.rotation ?? 0);
            } else {
              try {
                await fetch(`${API_BASE}/tables/${draggedTable.id}/position`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ position_x: draggedTable.position_x, position_y: draggedTable.position_y }),
                });
              } catch (error) {
                console.error("Error updating position:", error);
              }
            }
            setDraggedTable(null);
          }

          if (draggedIcon) {
            const pos = draggedIconCurrentPos.current || { x: draggedIcon.position_x, y: draggedIcon.position_y };
            try {
              await fetch(`${API_BASE}/icons/${draggedIcon.id}/position`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ position_x: pos.x, position_y: pos.y }),
              });
            } catch (error) {
              console.error("Error updating icon position:", error);
            }
            draggedIconCurrentPos.current = null;
            setDraggedIcon(null);
          }
        };

        const handleIconMouseDown = (e, icon) => {
          e.stopPropagation();
          const rect = e.currentTarget.getBoundingClientRect();
          setIconDragOffset({ x: e.clientX - rect.left, y: e.clientY - rect.top });
          setDraggedIcon(icon);
        };

        const handleDeleteIcon = async (iconId) => {
          try {
            await fetch(`${API_BASE}/icons/${iconId}`, { method: "DELETE" });
            setIcons((prev) => prev.filter((ic) => ic.id !== iconId));
          } catch (error) {
            console.error("Error deleting icon:", error);
          }
        };

        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center flex-wrap gap-3">
              <h3 className="font-serif text-2xl font-bold text-primary">Table Layout</h3>
              <div className="flex items-center gap-3 flex-wrap">
                {/* Layout size controls */}
                <div className="flex items-center gap-1" style={{ fontSize: "13px", color: "#666" }}>
                  <span style={{ fontWeight: 600, marginRight: "4px" }}>Canvas:</span>
                  <input
                    type="number"
                    min="400"
                    max="3000"
                    value={widthInput}
                    onChange={(e) => setWidthInput(e.target.value)}
                    onBlur={() => handleLayoutSize(parseInt(widthInput), layoutHeight)}
                    style={{ width: "70px", fontSize: "13px", padding: "4px 6px", borderRadius: "6px", border: "1px solid #d1d5db", textAlign: "center" }}
                    title="Canvas width (px)"
                  />
                  <span style={{ margin: "0 2px" }}>√ó</span>
                  <input
                    type="number"
                    min="300"
                    max="2000"
                    value={heightInput}
                    onChange={(e) => setHeightInput(e.target.value)}
                    onBlur={() => handleLayoutSize(layoutWidth, parseInt(heightInput))}
                    style={{ width: "70px", fontSize: "13px", padding: "4px 6px", borderRadius: "6px", border: "1px solid #d1d5db", textAlign: "center" }}
                    title="Canvas height (px)"
                  />
                  <span style={{ marginLeft: "2px", color: "#999" }}>px</span>
                </div>
                <button
                  onClick={handleSaveChanges}
                  disabled={saving}
                  className="btn-secondary"
                  style={{ opacity: saving ? 0.6 : 1 }}
                >
                  {saving ? "Saving‚Ä¶" : "üíæ Save Layout"}
                </button>
                <button onClick={() => setShowCreateModal(true)} className="btn-primary">
                  + Create Tables
                </button>
                <button
                  onClick={handleCopy}
                  className="btn-secondary"
                  disabled={!selectedTable}
                  style={{ opacity: selectedTable ? 1 : 0.4 }}
                  title={selectedTable ? `Copy ${selectedTable.table_name}` : "Select a table first"}
                >
                  üìã Copy
                </button>
                <button
                  onClick={handlePaste}
                  className="btn-secondary"
                  disabled={!clipboard}
                  style={{ opacity: clipboard ? 1 : 0.4 }}
                  title={clipboard ? `Paste ${clipboard.data.table_name}` : "Nothing copied yet"}
                >
                  üìå Paste
                </button>
                <button
                  onClick={handleClearLayout}
                  className="btn-secondary"
                  style={{ color: "#ef4444" }}
                >
                  üóë Clear Layout
                </button>

                {/* Venue layout background image controls */}
                <div style={{ display: "flex", alignItems: "center", gap: "6px", marginLeft: "8px", paddingLeft: "8px", borderLeft: "1px solid #e8dfd0" }}>
                  <input
                    ref={layoutImageInputRef}
                    type="file"
                    accept="image/*"
                    style={{ display: "none" }}
                    onChange={handleLayoutImageUpload}
                  />
                  <button
                    className="btn-secondary"
                    onClick={() => layoutImageInputRef.current?.click()}
                    title="Upload venue layout as background reference"
                  >
                    üñº {layoutImage ? "Change BG" : "Add BG"}
                  </button>
                  {layoutImage && (
                    <>
                      <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
                        <span style={{ fontSize: "11px", color: "#8b6f47", whiteSpace: "nowrap" }}>Opacity</span>
                        <input
                          type="range"
                          min="10" max="100" step="5"
                          value={imageOpacity}
                          onChange={e => setImageOpacity(Number(e.target.value))}
                          style={{ width: "70px", accentColor: "#d4af37" }}
                          title={`Background opacity: ${imageOpacity}%`}
                        />
                        <span style={{ fontSize: "11px", color: "#8b6f47", minWidth: "30px" }}>{imageOpacity}%</span>
                      </div>
                      <button
                        className="btn-secondary"
                        onClick={handleRemoveLayoutImage}
                        style={{ color: "#ef4444" }}
                        title="Remove background image"
                      >
                        ‚úï BG
                      </button>
                    </>
                  )}
                </div>
              </div>
            </div>

            <div style={{ position: "relative" }}>
                <div
                  ref={canvasRef}
                  className="canvas-container"
                  style={{ width: `${layoutWidth}px`, height: `${layoutHeight}px`, maxWidth: "100%", overflowX: "auto" }}
                  onMouseMove={handleMouseMove}
                  onMouseUp={handleMouseUp}
                  onMouseLeave={handleMouseUp}
                >
                  {/* Venue layout background image */}
                  {layoutImage && (
                    <img
                      src={layoutImage}
                      alt="Venue layout"
                      style={{
                        position: "absolute", top: 0, left: 0,
                        width: "100%", height: "100%",
                        objectFit: "contain",
                        opacity: imageOpacity / 100,
                        pointerEvents: "none",
                        userSelect: "none",
                        zIndex: 0,
                      }}
                    />
                  )}

                  {/* Layout icons */}
                  {icons.map((icon) => {
                    const def = LAYOUT_ICONS.find((d) => d.type === icon.icon_type) || { emoji: "üìå", label: icon.icon_type };
                    return (
                      <div
                        key={icon.id}
                        className="layout-icon"
                        style={{ left: `${icon.position_x}px`, top: `${icon.position_y}px` }}
                        onMouseDown={(e) => handleIconMouseDown(e, icon)}
                      >
                        <button
                          className="icon-remove-btn"
                          onClick={(e) => { e.stopPropagation(); handleDeleteIcon(icon.id); }}
                          onMouseDown={(e) => e.stopPropagation()}
                          title="Remove"
                        >‚úï</button>
                        <span className="layout-icon-emoji">{def.emoji}</span>
                        <span className="layout-icon-label">{def.label}</span>
                      </div>
                    );
                  })}

                  {/* Empty state when no tables */}
                  {tables.length === 0 && (
                    <div className="text-center py-20" style={{ pointerEvents: "none" }}>
                      <div className="text-6xl mb-4">ü™ë</div>
                      <h4 className="font-serif text-2xl font-bold text-primary mb-2">No tables yet</h4>
                      <p className="text-secondary mb-6">Create tables to start designing your event layout</p>
                      <button style={{ pointerEvents: "all" }} onClick={() => setShowCreateModal(true)} className="btn-primary">Create Tables</button>
                    </div>
                  )}

                  {/* Tables */}
                  {tables.map((table) => {
                    const n = table.capacity;
                    const S = 18;
                    const tableShape = table.shape || "circle";
                    const tablePurpose = table.purpose || "dining table";
                    const tableColor = table.color || "#ffffff";
                    const isDining = tablePurpose === "dining table";
                    const isRect = tableShape === "rectangle";
                    const doShowSeats = (table.show_seats ?? true) && n > 0;
                    const defaultW = isRect ? 140 : 100;
                    const defaultH = isRect ? 80 : 100;
                    const W = table.width || defaultW;
                    const H = table.height || defaultH;
                    const rot = table.rotation || 0;
                    const shapeStyle = isRect
                      ? { borderRadius: "8px", width: `${W}px`, height: `${H}px`, transform: rot ? `rotate(${rot}deg)` : undefined }
                      : { borderRadius: "50%", width: `${W}px`, height: `${H}px`, transform: rot ? `rotate(${rot}deg)` : undefined };

                    // Build seat positions using actual W/H
                    let seatPositions = [];
                    if (doShowSeats) {
                      if (!isRect) {
                        const R = W / 2 + 10; // seats just outside the circle
                        const cx0 = W / 2; const cy0 = H / 2;
                        seatPositions = Array.from({ length: n }, (_, i) => {
                          const angle = -Math.PI / 2 + (2 * Math.PI * i) / n;
                          return { cx: cx0 + R * Math.cos(angle) - S / 2, cy: cy0 + R * Math.sin(angle) - S / 2 };
                        });
                      } else {
                        const activeSides = parseSeatSides(table);
                        const SIDES_ORDER = ['top', 'bottom', 'left', 'right'];
                        const sidePosFns = {
                          top:    (i, total) => ({ cx: W * (i + 1) / (total + 1) - S / 2, cy: -(S + 4) }),
                          bottom: (i, total) => ({ cx: W * (i + 1) / (total + 1) - S / 2, cy: H + 4 }),
                          left:   (i, total) => ({ cx: -(S + 4), cy: H * (i + 1) / (total + 1) - S / 2 }),
                          right:  (i, total) => ({ cx: W + 4, cy: H * (i + 1) / (total + 1) - S / 2 }),
                        };
                        const activeList = SIDES_ORDER.filter(s => activeSides.has(s));
                        const numActive = activeList.length;
                        if (numActive > 0) {
                          const base = Math.floor(n / numActive);
                          const extra = n % numActive;
                          activeList.forEach((side, idx) => {
                            const count = base + (idx < extra ? 1 : 0);
                            for (let i = 0; i < count; i++) seatPositions.push(sidePosFns[side](i, count));
                          });
                        }
                      }
                    }

                    let occupiedSeats = null;
                    try {
                      const cached = localStorage.getItem(`seat_assignments_${table.id}`);
                      if (cached) {
                        const parsed = JSON.parse(cached);
                        if (Array.isArray(parsed) && parsed.length > 0)
                          occupiedSeats = new Set(parsed.map((sa) => sa.seat_number));
                      }
                    } catch {}

                    return (
                      <div
                        key={table.id}
                        className={`draggable-table${selectedTable && selectedTable.id === table.id ? " selected" : ""}`}
                        style={{ left: `${table.position_x}px`, top: `${table.position_y}px`, overflow: "visible", background: tableColor, ...shapeStyle }}
                        onMouseDown={(e) => handleTableMouseDown(e, table)}
                      >
                        {seatPositions.map((pos, i) => {
                          const seatNum = i + 1;
                          const occupied = occupiedSeats ? occupiedSeats.has(seatNum) : seatNum <= table.seats_occupied;
                          return (
                            <div key={i} className={`seat-around ${occupied ? "occupied" : "empty"}`}
                              style={{ left: pos.cx, top: pos.cy }} title={`Seat ${seatNum}`}>
                              {seatNum}
                            </div>
                          );
                        })}
                        <div className="font-bold text-primary" style={{ fontSize: "13px" }}>{table.table_name}</div>
                        {isDining && n > 0 && (
                          <div className="text-secondary" style={{ fontSize: "10px" }}>{table.seats_occupied}/{n}</div>
                        )}
                        {!isDining && (
                          <div style={{ fontSize: "10px", color: "#888", textTransform: "capitalize" }}>{tablePurpose}</div>
                        )}
                        {/* Resize handle */}
                        <div
                          onMouseDown={(e) => {
                            e.stopPropagation();
                            setResizingTable({ id: table.id, shape: tableShape, startW: W, startH: H });
                            setResizeStartPos({ x: e.clientX, y: e.clientY });
                          }}
                          style={{ position: "absolute", right: -6, bottom: -6, width: 13, height: 13, background: "#d4af37", border: "2px solid white", borderRadius: "50%", cursor: "se-resize", zIndex: 20 }}
                          title="Resize"
                        />
                      </div>
                    );
                  })}

                  {/* Table detail panel */}
                  {selectedTable && (
                    <TableDetailPanel
                      key={selectedTable.id}
                      table={tables.find((t) => t.id === selectedTable.id) || selectedTable}
                      guests={guests}
                      tableName={tableNameEdit}
                      setTableName={setTableNameEdit}
                      capacity={capacityEdit}
                      setCapacity={setCapacityEdit}
                      shape={shapeEdit}
                      setShape={handleShapeChange}
                      purpose={purposeEdit}
                      setPurpose={handlePurposeChange}
                      color={colorEdit}
                      setColor={handleColorChange}
                      seatSidesConfig={seatSidesConfigEdit}
                      setSeatSidesConfig={handleSeatSidesConfigChange}
                      showSeats={showSeatsEdit}
                      setShowSeats={handleShowSeatsChange}
                      rotation={rotationEdit}
                      setRotation={handleRotationChange}
                      onTableUpdate={handleTableUpdate}
                      onClose={() => setSelectedTable(null)}
                      onRefresh={onRefresh}
                      onDelete={handleDeleteTable}
                      onPositionChange={handlePositionChange}
                    />
                  )}
                </div>
              </div>

            {showCreateModal && (
              <CreateTablesModal
                onClose={() => setShowCreateModal(false)}
                onSubmit={handleCreateTables}
              />
            )}

          </div>
        );
      }

      // Table Detail Panel
      function TableDetailPanel({ table, guests, tableName, setTableName, capacity, setCapacity, shape, setShape, purpose, setPurpose, color, setColor, seatSidesConfig, setSeatSidesConfig, showSeats, setShowSeats, rotation, setRotation, onTableUpdate, onClose, onRefresh, onDelete, onPositionChange }) {

        const SEAT_CACHE_KEY = `seat_assignments_${table.id}`;

        const [seatAssignments, setSeatAssignments] = React.useState(() => {
          try { return JSON.parse(localStorage.getItem(SEAT_CACHE_KEY)) || []; } catch { return []; }
        });

        // Tracks tableOnly members the admin has dismissed without a specific seat assignment
        const [hiddenTableOnlyKeys, setHiddenTableOnlyKeys] = React.useState(new Set());

        // Auto-assign prompt: shown after first seat pick for a multi-member party
        const [autoAssignPrompt, setAutoAssignPrompt] = React.useState(null); // { guestId, guestName, partySize, alreadyAssigned }

        // Dismiss prompt automatically when the prompt's guest becomes fully seated
        React.useEffect(() => {
          if (!autoAssignPrompt) return;
          const assignedForGuest = seatAssignments.filter(sa => sa.guest_id === autoAssignPrompt.guestId).length;
          const guest = guests.find(g => g.id === autoAssignPrompt.guestId);
          if (guest && assignedForGuest >= guest.party_size) {
            setAutoAssignPrompt(null);
          }
        }, [seatAssignments]);

        const saveSeatAssignments = (data) => {
          setSeatAssignments(data);
          localStorage.setItem(SEAT_CACHE_KEY, JSON.stringify(data));
        };

        // Fresh cross-table seated-member map: guestId -> Set<memberNumber>
        const [seatedMembersMap, setSeatedMembersMap] = React.useState({});
        // Blocks the seat dropdown until fresh data is loaded (prevents stale-data assignments)
        const [isDataLoaded, setIsDataLoaded] = React.useState(false);

        React.useEffect(() => {
          setIsDataLoaded(false);
          const load = async () => {
            try {
              const [seatsRes, guestsRes] = await Promise.all([
                fetch(`${API_BASE}/tables/${table.id}/seats`),
                fetch(`${API_BASE}/events/${table.event_id}/guests`),
              ]);
              if (seatsRes.ok) {
                const d = await seatsRes.json();
                if (Array.isArray(d)) saveSeatAssignments(d);
              }
              if (guestsRes.ok) {
                const gd = await guestsRes.json();
                const map = {};
                for (const g of gd) map[g.id] = new Set((g.seated_members || []).map(Number));
                setSeatedMembersMap(map);
              }
            } catch (_) {}
            setIsDataLoaded(true);
          };
          load();
        }, [table.id]);

        const displayCapacity = parseInt(capacity) || table.capacity;

        // Count how many seat assignments each guest already has (by member_number)
        const assignedMembersByGuest = {};
        for (const sa of seatAssignments) {
          if (!assignedMembersByGuest[sa.guest_id]) assignedMembersByGuest[sa.guest_id] = new Set();
          assignedMembersByGuest[sa.guest_id].add(sa.member_number);
        }
        // Keep seatedMembersMap in sync with the guests prop (guests is refreshed via onRefresh
        // after every seat assignment, so this catches cross-table updates without re-fetching).
        React.useEffect(() => {
          if (!guests.length) return;
          setSeatedMembersMap(prev => {
            const next = { ...prev };
            for (const g of guests) {
              const fromProp = new Set((g.seated_members || []).map(Number));
              // Union with existing map so we never lose data from the fresh fetch
              next[g.id] = new Set([...(prev[g.id] || []), ...fromProp]);
            }
            return next;
          });
        }, [guests]);

        // Helper: get globally-seated member numbers for a guest.
        // Unions seatedMembersMap (fetched at mount) + prop's seated_members (kept fresh via onRefresh)
        // + current table's local assignments. Using both sources ensures that assignments made at
        // other tables after this panel mounted are still reflected in the dropdown.
        const getSeated = (gId) => {
          const propGuest = guests.find(g => g.id === gId);
          const fromMap = new Set([...(seatedMembersMap[gId] ?? [])].map(Number));
          const fromProp = new Set((propGuest?.seated_members || []).map(Number));
          return new Set([...fromMap, ...fromProp, ...(assignedMembersByGuest[gId] || [])]);
        };

        // A guest is "fully assigned" when EITHER:
        //  - unique seated member numbers >= party_size, OR
        //  - raw DB seat-assignment count >= party_size (handles duplicate member_numbers in DB)
        const isFullySeated = (g) => {
          const rawCount = Math.max(
            (g.seated_members || []).length,            // total DB rows (may have dupes)
            seatedMembersMap[g.id]?.size || 0           // unique from fresh fetch
          );
          const uniqueCount = getSeated(g.id).size;
          return Math.max(rawCount, uniqueCount) >= g.party_size;
        };

        const fullyAssignedGuestIds = new Set(guests.filter(isFullySeated).map(g => g.id));

        // Guests assigned to this table via table_id but with NO specific seat assignments yet.
        // Once any member of a party gets a seat, they leave this list entirely
        // (remaining unassigned members are handled via the GUESTS section + auto-assign prompt).
        const tableOnlyGuests = guests.filter(
          (g) => g.table_id === table.id && !fullyAssignedGuestIds.has(g.id) && !(assignedMembersByGuest[g.id]?.size > 0)
        );
        const expandedTableOnly = [];
        for (const g of tableOnlyGuests) {
          const globalSeatedNums = getSeated(g.id);
          for (let m = 1; m <= g.party_size; m++) {
            if (!globalSeatedNums.has(m) && !hiddenTableOnlyKeys.has(`${g.id}_${m}`))
              expandedTableOnly.push({ ...g, member: m });
          }
        }
        // Fill empty seat slots with table-only members (preserves old behaviour)
        const emptySeats = Array.from({ length: displayCapacity }, (_, i) => i + 1)
          .filter((sn) => !seatAssignments.find((sa) => sa.seat_number === sn));
        const seatToTableOnly = {};
        expandedTableOnly.forEach((member, idx) => {
          if (idx < emptySeats.length) seatToTableOnly[emptySeats[idx]] = member;
        });

        // Dropdown: guests with at least one unseated member; already-seated members shown as disabled.
        // Each party member is evaluated individually:
        //   - seated at another table  ‚Üí "(seated on Table X)"  disabled
        //   - seated at this table     ‚Üí "(seated)"             disabled
        //   - not seated yet           ‚Üí no extra tag           enabled
        const dropdownPool = guests.filter(g => !isFullySeated(g));
        const dropdownOptions = [];
        for (const g of dropdownPool) {
          const globalSeatedNums = getSeated(g.id);
          const memberCount = g.party_size > 1 ? g.party_size : 1;
          for (let m = 1; m <= memberCount; m++) {
            const seatedHere = !!assignedMembersByGuest[g.id]?.has(m);
            const seatedElsewhere = globalSeatedNums.has(m) && !seatedHere;
            const alreadySeated = seatedHere || seatedElsewhere;
            const memberLabel = g.party_size > 1
              ? `${g.name} ${m}/${g.party_size}`
              : g.name;
            let label;
            if (seatedElsewhere) {
              label = `${memberLabel} (seated on ${g.table_name || "another table"})`;
            } else if (seatedHere) {
              label = `${memberLabel} (seated)`;
            } else {
              // Not seated anywhere ‚Äî show table-assignment context if relevant
              const isOtherTable = g.table_id && g.table_id !== table.id;
              const tag = isOtherTable
                ? ` (split from ${g.table_name || "another table"})`
                : (g.table_id === table.id ? " (no seat #)" : "");
              label = `${memberLabel}${tag}`;
            }
            dropdownOptions.push({ value: `${g.id}_${m}`, label, disabled: alreadySeated });
          }
        }

        const handleAssignSeat = async (seatNumber, encodedValue) => {
          const [guestId, memberNumber] = encodedValue.split("_").map(Number);
          const guest = guests.find((g) => g.id === guestId);

          // Client-side cross-table conflict check (before any API call)
          const alreadyAtThisTable = assignedMembersByGuest[guestId]?.has(memberNumber);
          const alreadyElsewhere = !alreadyAtThisTable && (
            seatedMembersMap[guestId]?.has(memberNumber) ||
            (guest?.seated_members || []).includes(memberNumber)
          );
          if (alreadyElsewhere) {
            const guestLabel = guest
              ? (guest.party_size > 1 ? `${guest.name} ${memberNumber}/${guest.party_size}` : guest.name)
              : "This guest";
            const currentTableName = guest?.table_name || "another table";
            const confirmed = window.confirm(
              `${guestLabel} is already assigned to a seat at "${currentTableName}".\n\nMove them to this table instead?`
            );
            if (!confirmed) return;
            // Admin confirmed ‚Äî try to remove old seat (best effort)
            if (guest?.table_id && guest.table_id !== table.id) {
              try {
                const oldSeatsRes = await fetch(`${API_BASE}/tables/${guest.table_id}/seats`);
                if (oldSeatsRes.ok) {
                  const oldSeats = await oldSeatsRes.json();
                  const oldSeat = oldSeats.find(s => s.guest_id === guestId && s.member_number === memberNumber);
                  if (oldSeat) {
                    await fetch(`${API_BASE}/tables/${guest.table_id}/seats/${oldSeat.seat_number}`, { method: "DELETE" });
                  }
                }
              } catch (_) {}
            }
          }

          // Optimistic update
          if (guest) {
            saveSeatAssignments([
              ...seatAssignments.filter((sa) => sa.seat_number !== seatNumber),
              { seat_number: seatNumber, guest_id: guestId, member_number: memberNumber, guest_name: guest.name, party_size: guest.party_size },
            ]);
          }
          try {
            await fetch(`${API_BASE}/tables/${table.id}/seats`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ seat_number: seatNumber, guest_id: guestId, member_number: memberNumber }),
            });
            if (!guest?.table_id || guest.table_id === table.id) {
              await fetch(`${API_BASE}/guests/${guestId}/assign`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ table_id: table.id }),
              });
            }
            const r = await fetch(`${API_BASE}/tables/${table.id}/seats`);
            if (r.ok) { const d = await r.json(); if (Array.isArray(d)) saveSeatAssignments(d); }
            onRefresh();
          } catch (err) {
            console.error("Error assigning seat:", err);
          }
        };

        const handleRemoveSeat = async (seatNumber, guestId) => {
          const updatedAssignments = seatAssignments.filter((sa) => sa.seat_number !== seatNumber);
          saveSeatAssignments(updatedAssignments);
          try {
            await fetch(`${API_BASE}/tables/${table.id}/seats/${seatNumber}`, { method: "DELETE" });
            // Only unassign from table entirely if no other seat assignments remain for this guest
            const remainingForGuest = updatedAssignments.filter((sa) => sa.guest_id === guestId);
            if (remainingForGuest.length === 0) {
              await fetch(`${API_BASE}/guests/${guestId}/assign`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ table_id: null }),
              });
            }
            const r = await fetch(`${API_BASE}/tables/${table.id}/seats`);
            if (r.ok) { const d = await r.json(); if (Array.isArray(d)) saveSeatAssignments(d); }
            onRefresh();
          } catch (err) {
            console.error("Error removing seat:", err);
          }
        };

        const handleRemoveFromTable = async (guestId, memberNumber) => {
          const key = `${guestId}_${memberNumber}`;
          const newHidden = new Set([...hiddenTableOnlyKeys, key]);
          setHiddenTableOnlyKeys(newHidden);

          // Count how many of this guest's members are now accounted for
          const guest = guests.find((g) => g.id === guestId);
          const assignedCount = assignedMembersByGuest[guestId]?.size || 0;
          const hiddenCount = [...newHidden].filter((k) => k.startsWith(`${guestId}_`)).length;

          // Only unassign from table when ALL members are either seated or hidden
          if (assignedCount + hiddenCount >= (guest?.party_size || 1)) {
            try {
              await fetch(`${API_BASE}/guests/${guestId}/assign`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ table_id: null }),
              });
              onRefresh();
            } catch (err) {
              console.error("Error removing guest from table:", err);
            }
          }
        };

        const totalFilled = seatAssignments.length + expandedTableOnly.length;

        const handleDone = async () => {
          // Apply edits to local state immediately so they survive without a DB round-trip
          onTableUpdate({
            id: table.id,
            table_name: tableName,
            capacity: parseInt(capacity),
            shape,
            purpose,
            color,
            seat_sides: (seatSidesConfig || '').split(',').filter(Boolean).length,
            seat_sides_config: seatSidesConfig,
            show_seats: showSeats,
            rotation: rotation ?? 0,
            width: table.width,
            height: table.height,
            position_x: table.position_x,
            position_y: table.position_y,
          });
          onClose();
          // Persist to DB in the background (don't await ‚Äî don't overwrite local state with refresh)
          try {
            await fetch(`${API_BASE}/tables/${table.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ table_name: tableName, capacity: parseInt(capacity), shape, purpose, color, seat_sides: (seatSidesConfig || '').split(',').filter(Boolean).length, seat_sides_config: seatSidesConfig, show_seats: showSeats, rotation: rotation ?? 0, width: table.width, height: table.height }),
            });
            await fetch(`${API_BASE}/tables/${table.id}/position`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ position_x: table.position_x, position_y: table.position_y }),
            });
          } catch (error) {
            console.error("Error saving table:", error);
          }
        };

        return (
          <div className="table-detail-panel">
            {/* Header */}
            <div className="table-detail-header">
              <div className="font-bold text-primary" style={{ fontSize: "14px" }}>Table Settings</div>
              <div style={{ display: "flex", gap: "6px", alignItems: "center" }}>
                <button
                  onClick={handleDone}
                  style={{ padding: "4px 12px", background: "#d4af37", color: "white", border: "none", borderRadius: "6px", fontWeight: 700, cursor: "pointer", fontSize: "12px" }}
                >
                  Done
                </button>
                <button className="table-detail-close" onClick={onClose}>‚úï</button>
              </div>
            </div>

            {/* Editable name & capacity ‚Äî same row */}
            <div style={{ padding: "10px 14px 8px", borderBottom: "1px solid rgba(212,175,55,0.2)" }}>
              <div style={{ display: "flex", gap: "8px", marginBottom: "8px" }}>
                <div style={{ flex: 2 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>NAME</label>
                  <input
                    type="text"
                    value={tableName}
                    onChange={(e) => setTableName(e.target.value)}
                    style={{ width: "100%", fontSize: "13px", padding: "5px 8px", borderRadius: "6px", border: "1px solid #d1d5db", boxSizing: "border-box" }}
                  />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>SEATS</label>
                  <input
                    type="number"
                    min="0"
                    max="50"
                    value={capacity}
                    onChange={(e) => setCapacity(e.target.value)}
                    style={{ width: "100%", fontSize: "13px", padding: "5px 8px", borderRadius: "6px", border: "1px solid #d1d5db", boxSizing: "border-box" }}
                  />
                </div>
              </div>
              {/* X / Y position ‚Äî same row */}
              <div style={{ display: "flex", gap: "8px" }}>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>X</label>
                  <input
                    type="number"
                    min="0"
                    value={Math.round(table.position_x)}
                    onChange={(e) => onPositionChange(table.id, parseInt(e.target.value) || 0, table.position_y)}
                    style={{ width: "100%", fontSize: "13px", padding: "5px 8px", borderRadius: "6px", border: "1px solid #d1d5db", boxSizing: "border-box" }}
                  />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>Y</label>
                  <input
                    type="number"
                    min="0"
                    value={Math.round(table.position_y)}
                    onChange={(e) => onPositionChange(table.id, table.position_x, parseInt(e.target.value) || 0)}
                    style={{ width: "100%", fontSize: "13px", padding: "5px 8px", borderRadius: "6px", border: "1px solid #d1d5db", boxSizing: "border-box" }}
                  />
                </div>
              </div>
              {/* W / H / Rotation ‚Äî same row */}
              <div style={{ display: "flex", gap: "8px", marginTop: "8px" }}>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>W</label>
                  <input
                    type="number"
                    min="40"
                    value={Math.round(table.width || (table.shape === "rectangle" ? 140 : 100))}
                    onChange={(e) => onTableUpdate({ id: table.id, width: Math.max(40, parseInt(e.target.value) || 40) })}
                    style={{ width: "100%", fontSize: "13px", padding: "5px 8px", borderRadius: "6px", border: "1px solid #d1d5db", boxSizing: "border-box" }}
                  />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>H</label>
                  <input
                    type="number"
                    min="40"
                    value={Math.round(table.height || (table.shape === "rectangle" ? 80 : 100))}
                    onChange={(e) => onTableUpdate({ id: table.id, height: Math.max(40, parseInt(e.target.value) || 40) })}
                    style={{ width: "100%", fontSize: "13px", padding: "5px 8px", borderRadius: "6px", border: "1px solid #d1d5db", boxSizing: "border-box" }}
                  />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>ROT¬∞</label>
                  <input
                    type="number"
                    min="0"
                    max="359"
                    value={rotation ?? 0}
                    onChange={(e) => setRotation(parseInt(e.target.value) || 0)}
                    style={{ width: "100%", fontSize: "13px", padding: "5px 8px", borderRadius: "6px", border: "1px solid #d1d5db", boxSizing: "border-box" }}
                  />
                </div>
              </div>
            </div>

            {/* Shape / Purpose / Color */}
            <div style={{ padding: "10px 14px 8px", borderBottom: "1px solid rgba(212,175,55,0.2)" }}>
              <div style={{ display: "flex", gap: "8px", marginBottom: "8px" }}>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>SHAPE</label>
                  <select value={shape} onChange={(e) => setShape(e.target.value)}
                    style={{ width: "100%", fontSize: "12px", padding: "5px 6px", borderRadius: "6px", border: "1px solid #d1d5db" }}>
                    <option value="circle">Circle</option>
                    <option value="rectangle">Rectangle</option>
                  </select>
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>BODY COLOR</label>
                  <input type="color" value={color} onChange={(e) => setColor(e.target.value)}
                    style={{ width: "100%", height: "32px", padding: "2px", borderRadius: "6px", border: "1px solid #d1d5db", cursor: "pointer" }} />
                </div>
              </div>
              <div>
                <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "3px" }}>PURPOSE</label>
                <select value={purpose} onChange={(e) => setPurpose(e.target.value)}
                  style={{ width: "100%", fontSize: "12px", padding: "5px 6px", borderRadius: "6px", border: "1px solid #d1d5db" }}>
                  <option value="dining table">Dining Table</option>
                  <option value="stage">Stage</option>
                  <option value="pillar">Pillar</option>
                  <option value="carpet">Carpet</option>
                  <option value="other">Other</option>
                </select>
              </div>
              {shape === "rectangle" && (
                <div style={{ marginTop: "8px" }}>
                  <label style={{ fontSize: "11px", fontWeight: 600, color: "#888", display: "block", marginBottom: "5px" }}>SEAT SIDES</label>
                  {(() => {
                    const activeSides = new Set((seatSidesConfig || '').split(',').filter(Boolean));
                    const toggle = (side, checked) => {
                      const s = new Set(activeSides);
                      checked ? s.add(side) : s.delete(side);
                      setSeatSidesConfig([...s].join(','));
                    };
                    const chk = (side, label) => (
                      <label key={side} style={{ display: "flex", alignItems: "center", gap: "5px", fontSize: "12px", cursor: "pointer", userSelect: "none" }}>
                        <input type="checkbox" checked={activeSides.has(side)} onChange={(e) => toggle(side, e.target.checked)} style={{ cursor: "pointer" }} />
                        {label}
                      </label>
                    );
                    return (
                      <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: "4px" }}>
                        {chk('top', 'Top')}
                        <div style={{ display: "flex", gap: "24px" }}>
                          {chk('left', 'Left')}
                          {chk('right', 'Right')}
                        </div>
                        {chk('bottom', 'Bottom')}
                      </div>
                    );
                  })()}
                </div>
              )}
              <div style={{ marginTop: "8px", display: "flex", alignItems: "center", gap: "8px" }}>
                <input type="checkbox" id="show-seats-toggle" checked={showSeats} onChange={(e) => setShowSeats(e.target.checked)}
                  style={{ width: "14px", height: "14px", cursor: "pointer" }} />
                <label htmlFor="show-seats-toggle" style={{ fontSize: "11px", fontWeight: 600, color: "#888", cursor: "pointer" }}>SHOW SEATS</label>
              </div>
            </div>

            {/* Guest-centric seat assignment ‚Äî one row per guest */}
            {(() => {
              const tableGuests = guests.filter(g => g.table_id === table.id);
              const totalMembers = tableGuests.reduce((acc, g) => acc + g.party_size, 0);
              return (
                <>
                  <div style={{ padding: "8px 14px 2px", borderTop: "1px solid rgba(212,175,55,0.2)", fontSize: "11px", fontWeight: 600, color: "#888" }}>
                    GUESTS ‚Äî {totalMembers} member{totalMembers !== 1 ? "s" : ""}
                  </div>
                  {tableGuests.length === 0 ? (
                    <div style={{ padding: "4px 14px 10px", fontSize: "12px", color: "#aaa" }}>No guests assigned to this table</div>
                  ) : (
                    <div style={{ paddingBottom: "6px" }}>
                      {tableGuests.map(g => {
                        const guestAssignments = seatAssignments.filter(sa => sa.guest_id === g.id);
                        // Count globally-seated members (cross-table) + local assignments for this table
                        const globalSeatedNums = getSeated(g.id);
                        const assignedCount = globalSeatedNums.size;
                        const fullyAssigned = assignedCount >= g.party_size;
                        const remaining = g.party_size - assignedCount;
                        const isPromptActive = autoAssignPrompt?.guestId === g.id;
                        // Indicator: gold ‚úì = all seated, amber = partially seated (shows remaining count), grey = none seated
                        const indicatorBg = fullyAssigned ? "#d4af37" : assignedCount > 0 ? "#f59e0b" : "#e5e7eb";
                        const indicatorLabel = fullyAssigned ? "‚úì" : (g.party_size > 1 ? String(remaining) : "‚Äì");
                        return (
                          <React.Fragment key={`g_${g.id}`}>
                            <div style={{ display: "flex", alignItems: "center", gap: "6px", padding: "5px 14px", borderBottom: isPromptActive ? "none" : "1px solid #f3f4f6", fontSize: "12px" }}>
                              {/* Assignment indicator */}
                              <div style={{ width: "20px", height: "20px", borderRadius: "50%", flexShrink: 0, display: "flex", alignItems: "center", justifyContent: "center", background: indicatorBg, border: "2px solid white", boxShadow: "0 1px 3px rgba(0,0,0,0.15)" }}>
                                <span style={{ fontSize: "7px", fontWeight: 700, color: assignedCount > 0 ? "white" : "#999", lineHeight: 1 }}>
                                  {indicatorLabel}
                                </span>
                              </div>
                              {/* Guest name + not-seated count (info only, no dropdown) */}
                              <span style={{ flex: 1, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap", color: "#333", fontWeight: assignedCount > 0 ? 600 : 400 }}>
                                {g.name}
                                {g.party_size > 1 && !fullyAssigned
                                  ? <span style={{ marginLeft: "5px", fontSize: "10px", color: "#f59e0b", fontWeight: 500 }}>{remaining} not seated</span>
                                  : g.party_size > 1
                                    ? <span style={{ marginLeft: "5px", fontSize: "10px", color: "#d4af37", fontWeight: 500 }}>all seated</span>
                                    : null}
                              </span>
                            </div>

                            {/* Auto-assign prompt ‚Äî shown inline below the guest row */}
                            {isPromptActive && (
                              <div style={{ margin: "0 14px 8px", padding: "8px 10px", background: "#fffbeb", border: "1px solid #fde68a", borderRadius: "6px", fontSize: "11px", borderTop: "none" }}>
                                <div style={{ marginBottom: "6px", color: "#92400e", lineHeight: 1.4 }}>
                                  Auto-assign the remaining <strong>{g.party_size - autoAssignPrompt.alreadyAssigned}</strong> member{g.party_size - autoAssignPrompt.alreadyAssigned !== 1 ? "s" : ""} of <strong>{g.name}</strong> to next available seats?
                                </div>
                                <div style={{ display: "flex", gap: "6px" }}>
                                  <button
                                    onClick={async () => {
                                      // Batch-assign all remaining members in one go
                                      // Use global seated_members + local seatAssignments to avoid re-assigning cross-table members
                                      const currentAssigned = new Set(seatAssignments.map(sa => sa.seat_number));
                                      const alreadyMemberNums = getSeated(g.id);
                                      const remaining = Array.from({ length: g.party_size }, (_, i) => i + 1).filter(n => !alreadyMemberNums.has(n));
                                      const avail = Array.from({ length: displayCapacity }, (_, i) => i + 1).filter(sn => !currentAssigned.has(sn));
                                      const newAssignments = remaining.slice(0, avail.length).map((memberNum, i) => ({
                                        seat_number: avail[i], guest_id: g.id, member_number: memberNum,
                                        guest_name: g.name, party_size: g.party_size,
                                      }));
                                      // Optimistic update: add all at once
                                      saveSeatAssignments([...seatAssignments, ...newAssignments]);
                                      // Persist in parallel
                                      await Promise.all(newAssignments.map(na =>
                                        fetch(`${API_BASE}/tables/${table.id}/seats`, {
                                          method: "POST",
                                          headers: { "Content-Type": "application/json" },
                                          body: JSON.stringify({ seat_number: na.seat_number, guest_id: na.guest_id, member_number: na.member_number }),
                                        })
                                      ));
                                      // Re-fetch once to sync
                                      const r = await fetch(`${API_BASE}/tables/${table.id}/seats`);
                                      if (r.ok) { const d = await r.json(); if (Array.isArray(d)) saveSeatAssignments(d); }
                                      setAutoAssignPrompt(null);
                                    }}
                                    style={{ flex: 1, padding: "5px 8px", background: "#d4af37", color: "white", border: "none", borderRadius: "5px", fontSize: "11px", cursor: "pointer", fontWeight: 600 }}
                                  >
                                    Yes, auto-assign
                                  </button>
                                  <button
                                    onClick={() => setAutoAssignPrompt(null)}
                                    style={{ flex: 1, padding: "5px 8px", background: "white", color: "#666", border: "1px solid #d1d5db", borderRadius: "5px", fontSize: "11px", cursor: "pointer" }}
                                  >
                                    No, manual
                                  </button>
                                </div>
                              </div>
                            )}
                          </React.Fragment>
                        );
                      })}
                    </div>
                  )}
                </>
              );
            })()}

            {/* Seats section header */}
            <div style={{ padding: "8px 14px 2px", borderTop: "1px solid rgba(212,175,55,0.2)", fontSize: "11px", fontWeight: 600, color: "#888" }}>
              SEATS ‚Äî {totalFilled}/{displayCapacity} filled
            </div>

            {/* Seat rows */}
            <div style={{ paddingBottom: "8px" }}>
              {Array.from({ length: displayCapacity }, (_, i) => {
                const seatNum = i + 1;
                const assignment = seatAssignments.find((sa) => sa.seat_number === seatNum) || null;
                const tableOnlyMember = !assignment ? seatToTableOnly[seatNum] : null;
                return (
                  <div key={i} className="seat-row">
                    <div className="seat-number">{seatNum}</div>
                    {assignment ? (
                      <>
                        <span style={{ flex: 1, fontSize: "12px", fontWeight: 600, color: "#2d2d2d", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                          {assignment.party_size > 1
                            ? `${assignment.guest_name} ${assignment.member_number}/${assignment.party_size}`
                            : assignment.guest_name}
                        </span>
                        <button
                          onClick={() => handleRemoveSeat(seatNum, assignment.guest_id)}
                          style={{ fontSize: "11px", color: "#ef4444", background: "none", border: "none", cursor: "pointer", padding: "2px 4px", flexShrink: 0 }}
                          title="Remove from seat"
                        >‚úï</button>
                      </>
                    ) : tableOnlyMember ? (
                      <>
                        <span style={{ flex: 1, fontSize: "12px", fontWeight: 600, color: "#2d2d2d", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                          {tableOnlyMember.party_size > 1 ? `${tableOnlyMember.name} ${tableOnlyMember.member}/${tableOnlyMember.party_size}` : tableOnlyMember.name}
                        </span>
                        <button
                          onClick={() => handleRemoveFromTable(tableOnlyMember.id, tableOnlyMember.member)}
                          style={{ fontSize: "11px", color: "#ef4444", background: "none", border: "none", cursor: "pointer", padding: "2px 4px", flexShrink: 0 }}
                          title="Remove from table"
                        >‚úï</button>
                      </>
                    ) : (
                      <select
                        value=""
                        disabled={!isDataLoaded}
                        onChange={async (e) => {
                          const val = e.target.value;
                          if (!val) return;
                          const [guestId, memberNumber] = val.split("_").map(Number);
                          const guest = guests.find(g => g.id === guestId);
                          await handleAssignSeat(seatNum, val);
                          // After assigning, offer auto-assign for remaining party members
                          if (guest && guest.party_size > 1) {
                            const alreadyAssigned = (assignedMembersByGuest[guestId]?.size || 0) + 1;
                            const leftOver = guest.party_size - alreadyAssigned;
                            if (leftOver > 0) {
                              setAutoAssignPrompt({ guestId, guestName: guest.name, partySize: guest.party_size, alreadyAssigned });
                            }
                          }
                        }}
                        style={{ flex: 1, fontSize: "11px", padding: "2px 4px", borderRadius: "5px", border: "1px solid #d1d5db", color: "#666" }}
                      >
                        <option value="">{isDataLoaded ? "‚Äî empty ‚Äî" : "Loading‚Ä¶"}</option>
                        {isDataLoaded && dropdownOptions.map((opt, idx) => (
                          <option key={`${opt.value}-${idx}`} value={opt.value} disabled={opt.disabled}>{opt.label}</option>
                        ))}
                      </select>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Delete table */}
            <div style={{ padding: "10px 14px", borderTop: "1px solid rgba(212,175,55,0.2)" }}>
              <button
                onClick={() => { onDelete(table.id, table.table_name); onClose(); }}
                style={{ width: "100%", padding: "8px", background: "white", color: "#ef4444", border: "1px solid #ef4444", borderRadius: "8px", fontWeight: 600, cursor: "pointer", fontSize: "13px" }}
              >
                üóë Delete
              </button>
            </div>
          </div>
        );
      }

      // Create Tables Modal
      function CreateTablesModal({ onClose, onSubmit }) {
        const [numTables, setNumTables] = useState(10);
        const [seatsPerTable, setSeatsPerTable] = useState(10);
        const [prefix, setPrefix] = useState("T");
        const [shape, setShape] = useState("circle");
        const [purpose, setPurpose] = useState("dining table");
        const [color, setColor] = useState("#ffffff");
        const [seatSidesConfig, setSeatSidesConfig] = useState("top,bottom");
        const [showSeats, setShowSeats] = useState(true);

        const handleSubmit = (e) => {
          e.preventDefault();
          const tables = Array.from({ length: numTables }, (_, i) => ({
            table_name: `${prefix}${i + 1}`,
            capacity: seatsPerTable,
            shape,
            purpose,
            color,
            seat_sides: seatSidesConfig.split(',').filter(Boolean).length,
            seat_sides_config: seatSidesConfig,
            show_seats: showSeats,
          }));
          onSubmit(tables);
        };

        return (
          <div className="qr-modal" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <h3 className="font-serif text-3xl font-bold text-primary mb-6">
                Create Tables
              </h3>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Number of Tables
                  </label>
                  <input
                    type="number"
                    min="1"
                    max="100"
                    required
                    className="input-field"
                    value={numTables}
                    onChange={(e) => setNumTables(parseInt(e.target.value))}
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Seats Per Table
                  </label>
                  <input
                    type="number"
                    min="0"
                    max="200"
                    required
                    className="input-field"
                    value={seatsPerTable}
                    onChange={(e) => setSeatsPerTable(parseInt(e.target.value))}
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Table Prefix
                  </label>
                  <input
                    type="text"
                    maxLength="3"
                    required
                    className="input-field"
                    placeholder="e.g., T, A, Table"
                    value={prefix}
                    onChange={(e) => setPrefix(e.target.value)}
                  />
                  <p className="text-xs text-secondary mt-1">
                    Tables will be named: {prefix}1, {prefix}2, ...
                  </p>
                </div>
                <div className="flex space-x-3">
                  <div className="flex-1">
                    <label className="block text-sm font-semibold text-primary mb-2">Shape</label>
                    <select className="input-field" value={shape} onChange={(e) => setShape(e.target.value)}>
                      <option value="circle">Circle</option>
                      <option value="rectangle">Rectangle</option>
                    </select>
                  </div>
                  <div className="flex-1">
                    <label className="block text-sm font-semibold text-primary mb-2">Body Color</label>
                    <input type="color" className="input-field" style={{ height: "42px", padding: "4px", cursor: "pointer" }}
                      value={color} onChange={(e) => setColor(e.target.value)} />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">Purpose</label>
                  <select className="input-field" value={purpose} onChange={(e) => { const v = e.target.value; setPurpose(v); if (v !== "dining table") setSeatsPerTable(0); }}>
                    <option value="dining table">Dining Table</option>
                    <option value="stage">Stage</option>
                    <option value="pillar">Pillar</option>
                    <option value="carpet">Carpet</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                {shape === "rectangle" && (
                  <div>
                    <label className="block text-sm font-semibold text-primary mb-2">Seat Sides</label>
                    {(() => {
                      const activeSides = new Set((seatSidesConfig || '').split(',').filter(Boolean));
                      const toggle = (side, checked) => {
                        const s = new Set(activeSides);
                        checked ? s.add(side) : s.delete(side);
                        setSeatSidesConfig([...s].join(','));
                      };
                      const chk = (side, label) => (
                        <label key={side} style={{ display: "flex", alignItems: "center", gap: "6px", fontSize: "14px", cursor: "pointer", userSelect: "none" }}>
                          <input type="checkbox" checked={activeSides.has(side)} onChange={(e) => toggle(side, e.target.checked)} style={{ width: "15px", height: "15px", cursor: "pointer" }} />
                          {label}
                        </label>
                      );
                      return (
                        <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: "5px" }}>
                          {chk('top', 'Top')}
                          <div style={{ display: "flex", gap: "32px" }}>
                            {chk('left', 'Left')}
                            {chk('right', 'Right')}
                          </div>
                          {chk('bottom', 'Bottom')}
                        </div>
                      );
                    })()}
                  </div>
                )}
                <div className="flex items-center gap-2">
                  <input type="checkbox" id="modal-show-seats" checked={showSeats} onChange={(e) => setShowSeats(e.target.checked)}
                    style={{ width: "16px", height: "16px", cursor: "pointer" }} />
                  <label htmlFor="modal-show-seats" className="text-sm font-semibold text-primary" style={{ cursor: "pointer" }}>Show seats around table</label>
                </div>
                <div className="flex space-x-3 pt-4">
                  <button type="submit" className="btn-primary flex-1">
                    Create {numTables} Tables
                  </button>
                  <button
                    type="button"
                    onClick={onClose}
                    className="btn-secondary flex-1"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      // Edit Table Modal
      function EditTableModal({ table, onClose, onSave }) {
        const [tableName, setTableName] = useState(table.table_name);
        const [capacity, setCapacity] = useState(table.capacity);

        const handleSubmit = (e) => {
          e.preventDefault();
          onSave(table.id, tableName, parseInt(capacity));
        };

        return (
          <div className="qr-modal" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <h3 className="font-serif text-3xl font-bold text-primary mb-6">
                Edit Table
              </h3>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Table Name
                  </label>
                  <input
                    type="text"
                    required
                    className="input-field"
                    value={tableName}
                    onChange={(e) => setTableName(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Seat Capacity
                  </label>
                  <input
                    type="number"
                    min="1"
                    max="50"
                    required
                    className="input-field"
                    value={capacity}
                    onChange={(e) => setCapacity(e.target.value)}
                  />
                  {table.seats_occupied > 0 && (
                    <p className="text-xs text-secondary mt-1">
                      {table.seats_occupied} guest(s) currently assigned to this table
                    </p>
                  )}
                </div>
                <div className="flex space-x-3 pt-4">
                  <button type="submit" className="btn-primary flex-1">
                    Save Changes
                  </button>
                  <button
                    type="button"
                    onClick={onClose}
                    className="btn-secondary flex-1"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      // Guests Tab
      function GuestsTab({ eventId, guests, tables, onRefresh }) {
        const [showAddModal, setShowAddModal] = useState(false);
        const [selectedGuest, setSelectedGuest] = useState(null);

        const handleAddGuest = async (guestData) => {
          try {
            await fetch(`${API_BASE}/events/${eventId}/guests`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(guestData),
            });
            setShowAddModal(false);
            onRefresh();
          } catch (error) {
            console.error("Error adding guest:", error);
          }
        };

        const handleAssignTable = async (guestId, tableId) => {
          try {
            await fetch(`${API_BASE}/guests/${guestId}/assign`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ table_id: tableId }),
            });
            onRefresh();
          } catch (error) {
            console.error("Error assigning table:", error);
          }
        };

        const handleDeleteGuest = async (guestId) => {
          if (confirm("Are you sure you want to delete this guest?")) {
            try {
              await fetch(`${API_BASE}/guests/${guestId}`, {
                method: "DELETE",
              });
              onRefresh();
            } catch (error) {
              console.error("Error deleting guest:", error);
            }
          }
        };

        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h3 className="font-serif text-2xl font-bold text-primary">
                Guest List
              </h3>
              <button
                onClick={() => setShowAddModal(true)}
                className="btn-primary"
              >
                + Add Guest
              </button>
            </div>

            {guests.length === 0 ? (
              <div className="text-center py-20 glass rounded-xl">
                <div className="text-6xl mb-4">üë•</div>
                <h4 className="font-serif text-2xl font-bold text-primary mb-2">
                  No guests yet
                </h4>
                <p className="text-secondary mb-6">
                  Add guests to generate QR invitations
                </p>
                <button
                  onClick={() => setShowAddModal(true)}
                  className="btn-primary"
                >
                  Add Your First Guest
                </button>
              </div>
            ) : (
              <div className="space-y-3">
                {guests.map((guest) => (
                  <div key={guest.id} className="guest-card">
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <div className="flex items-center space-x-3 mb-1">
                          <h4 className="font-semibold text-primary">
                            {guest.name}
                          </h4>
                          {guest.group_name && (
                            <span className="text-xs bg-accent/20 text-secondary px-2 py-1 rounded">
                              {guest.group_name}
                            </span>
                          )}
                        </div>
                        <div className="text-sm text-secondary">
                          Party Size: {guest.party_size} ‚Ä¢
                          {guest.email && ` ${guest.email}`}
                          {guest.phone && ` ‚Ä¢ ${guest.phone}`}
                        </div>
                      </div>
                      <div className="flex items-center space-x-3">
                        <select
                          value={guest.table_id || ""}
                          onChange={(e) =>
                            handleAssignTable(guest.id, e.target.value || null)
                          }
                          className="input-field text-sm py-2"
                        >
                          <option value="">No Table</option>
                          {tables.map((table) => (
                            <option key={table.id} value={table.id}>
                              {table.table_name} ({table.seats_occupied}/
                              {table.capacity})
                            </option>
                          ))}
                        </select>
                        <button
                          onClick={() => setSelectedGuest(guest)}
                          className="btn-secondary py-2 px-4 text-sm"
                        >
                          üì± QR
                        </button>
                        <button
                          onClick={() => handleDeleteGuest(guest.id)}
                          className="text-red-500 hover:text-red-700 text-xl"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {showAddModal && (
              <AddGuestModal
                onClose={() => setShowAddModal(false)}
                onSubmit={handleAddGuest}
                tables={tables}
              />
            )}

            {selectedGuest && (
              <QRCodeModal
                guest={selectedGuest}
                onClose={() => setSelectedGuest(null)}
              />
            )}
          </div>
        );
      }

      // Add Guest Modal
      function AddGuestModal({ onClose, onSubmit, tables }) {
        const [formData, setFormData] = useState({
          name: "",
          email: "",
          phone: "",
          group_name: "",
          party_size: 1,
          table_id: "",
        });

        const handleSubmit = (e) => {
          e.preventDefault();
          onSubmit(formData);
        };

        return (
          <div className="qr-modal" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <h3 className="font-serif text-3xl font-bold text-primary mb-6">
                Add Guest
              </h3>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Name *
                  </label>
                  <input
                    type="text"
                    required
                    className="input-field"
                    placeholder="John Smith"
                    value={formData.name}
                    onChange={(e) =>
                      setFormData({ ...formData, name: e.target.value })
                    }
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-primary mb-2">
                      Email
                    </label>
                    <input
                      type="email"
                      className="input-field"
                      placeholder="john@email.com"
                      value={formData.email}
                      onChange={(e) =>
                        setFormData({ ...formData, email: e.target.value })
                      }
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-primary mb-2">
                      Phone
                    </label>
                    <input
                      type="tel"
                      className="input-field"
                      placeholder="+60123456789"
                      value={formData.phone}
                      onChange={(e) =>
                        setFormData({ ...formData, phone: e.target.value })
                      }
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-primary mb-2">
                      Group
                    </label>
                    <input
                      type="text"
                      className="input-field"
                      placeholder="Family, Friends, etc."
                      value={formData.group_name}
                      onChange={(e) =>
                        setFormData({ ...formData, group_name: e.target.value })
                      }
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-primary mb-2">
                      Party Size
                    </label>
                    <input
                      type="number"
                      min="1"
                      className="input-field"
                      value={formData.party_size}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          party_size: parseInt(e.target.value),
                        })
                      }
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-primary mb-2">
                    Assign Table
                  </label>
                  <select
                    className="input-field"
                    value={formData.table_id}
                    onChange={(e) =>
                      setFormData({ ...formData, table_id: e.target.value })
                    }
                  >
                    <option value="">Select later</option>
                    {tables.map((table) => (
                      <option key={table.id} value={table.id}>
                        {table.table_name} ({table.seats_occupied}/
                        {table.capacity} seats)
                      </option>
                    ))}
                  </select>
                </div>
                <div className="flex space-x-3 pt-4">
                  <button type="submit" className="btn-primary flex-1">
                    Add Guest
                  </button>
                  <button
                    type="button"
                    onClick={onClose}
                    className="btn-secondary flex-1"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      // QR Code Modal
      function QRCodeModal({ guest, onClose }) {
        const qrRef = useRef(null);
        const guestUrl = `${GUEST_BASE_URL}${guest.qr_code}`;

        useEffect(() => {
          if (qrRef.current && !qrRef.current.hasChildNodes()) {
            // Clear any existing QR code
            qrRef.current.innerHTML = "";

            // Generate QR code
            new QRCode(qrRef.current, {
              text: guestUrl,
              width: 300,
              height: 300,
              colorDark: "#2c1810",
              colorLight: "#faf8f5",
              correctLevel: QRCode.CorrectLevel.H,
            });
          }
        }, [guestUrl]);

        const handleDownload = () => {
          const canvas = qrRef.current.querySelector("canvas");
          if (canvas) {
            const url = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.download = `qr-${guest.name.replace(/\s+/g, "-")}.png`;
            link.href = url;
            link.click();
          }
        };

        return (
          <div className="qr-modal" onClick={onClose}>
            <div
              className="modal-content text-center"
              onClick={(e) => e.stopPropagation()}
            >
              <h3 className="font-serif text-3xl font-bold text-primary mb-2">
                {guest.name}
              </h3>
              <p className="text-secondary mb-6">
                {guest.group_name && `${guest.group_name} ‚Ä¢ `}
                Party of {guest.party_size}
                {guest.table_name && ` ‚Ä¢ Table ${guest.table_name}`}
              </p>
              <div className="bg-white p-4 rounded-xl border-2 border-accent inline-block mb-6">
                <div ref={qrRef}></div>
              </div>
              <p className="text-sm text-secondary mb-6 break-all">
                {guestUrl}
              </p>
              <div className="flex space-x-3">
                <button onClick={handleDownload} className="btn-primary flex-1">
                  Download QR Code
                </button>
                <button onClick={onClose} className="btn-secondary flex-1">
                  Close
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Guest View Component (Demo)
      function GuestViewDemo() {
        const [qrCode, setQrCode] = useState("");
        const [guestData, setGuestData] = useState(null);
        const [layout, setLayout] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");

        const handleLookup = async () => {
          if (!qrCode.trim()) return;

          setLoading(true);
          setError("");

          try {
            const [guestRes, layoutRes] = await Promise.all([
              fetch(`${API_BASE}/guest/${qrCode}`),
              fetch(`${API_BASE}/guest/${qrCode}/layout`),
            ]);

            if (!guestRes.ok) {
              throw new Error("Invalid QR code");
            }

            setGuestData(await guestRes.json());
            setLayout(await layoutRes.json());
          } catch (err) {
            setError(err.message);
            setGuestData(null);
            setLayout(null);
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="min-h-screen pattern-bg py-12">
            <div className="max-w-2xl mx-auto px-4">
              <div className="text-center mb-8">
                <h2 className="font-serif text-4xl font-bold text-primary mb-2">
                  Guest View Demo
                </h2>
                <p className="text-secondary">
                  Test the guest QR code experience
                </p>
              </div>

              <div className="glass rounded-xl p-6 mb-6">
                <label className="block text-sm font-semibold text-primary mb-2">
                  Enter QR Code
                </label>
                <div className="flex space-x-3">
                  <input
                    type="text"
                    className="input-field flex-1"
                    placeholder="Paste QR code here"
                    value={qrCode}
                    onChange={(e) => setQrCode(e.target.value)}
                    onKeyPress={(e) => e.key === "Enter" && handleLookup()}
                  />
                  <button
                    onClick={handleLookup}
                    className="btn-primary"
                    disabled={loading}
                  >
                    {loading ? "Loading..." : "View"}
                  </button>
                </div>
                {error && (
                  <p className="text-red-500 text-sm mt-2">‚ùå {error}</p>
                )}
              </div>

              {guestData && <GuestView guestData={guestData} layout={layout} />}
            </div>
          </div>
        );
      }

      // Guest View Component (Actual View)
      function GuestView({ guestData, layout }) {
        return (
          <div className="glass rounded-xl overflow-hidden">
            {/* Header */}
            <div className="gradient-primary text-white p-8 text-center">
              <div className="text-5xl mb-3">üéâ</div>
              <h1 className="font-serif text-3xl font-bold mb-2">
                {guestData.event_name}
              </h1>
              <p className="text-white/80">
                üìÖ {new Date(guestData.event_date).toLocaleDateString()}
              </p>
              <p className="text-white/80">üìç {guestData.event_venue}</p>
            </div>

            {/* Guest Info */}
            <div className="p-8 border-b border-border">
              <div className="text-center">
                <h2 className="font-serif text-3xl font-bold text-primary mb-2">
                  Welcome!
                </h2>
                <p className="text-xl text-secondary mb-1">
                  üë§ {guestData.name}
                </p>
                {guestData.group_name && (
                  <p className="text-secondary">
                    Group: {guestData.group_name}
                  </p>
                )}
                <p className="text-secondary">
                  Party Size: {guestData.party_size}
                </p>
              </div>
            </div>

            {/* Table Assignment */}
            {guestData.table_name ? (
              <>
                <div className="p-8 text-center">
                  <p className="text-secondary mb-3">Your Assigned Table</p>
                  <div className="inline-block bg-accent text-primary rounded-2xl px-12 py-8">
                    <div className="text-6xl font-bold font-serif">
                      {guestData.table_name}
                    </div>
                  </div>
                </div>

                {/* Hall Layout */}
                {layout && layout.tables && (
                  <div className="p-8 bg-gray-50">
                    <h3 className="font-serif text-2xl font-bold text-primary mb-4 text-center">
                      Hall Layout
                    </h3>
                    <div className="bg-white rounded-xl border-2 border-border p-4 relative h-96 overflow-hidden">
                      {layout.tables.map((table) => (
                        <div
                          key={table.id}
                          className={`absolute rounded-lg p-3 text-center ${
                            table.id === layout.guestTableId
                              ? "bg-accent text-primary font-bold shadow-lg scale-110"
                              : "bg-gray-100 text-secondary"
                          }`}
                          style={{
                            left: `${(table.position_x / 800) * 100}%`,
                            top: `${(table.position_y / 600) * 100}%`,
                            width: "60px",
                            height: "60px",
                            transform:
                              table.id === layout.guestTableId
                                ? "scale(1.1)"
                                : "scale(1)",
                          }}
                        >
                          <div className="text-sm font-bold">
                            {table.table_name}
                          </div>
                        </div>
                      ))}
                    </div>
                    <p className="text-center text-secondary mt-4">
                      ‚≠ê Your table is highlighted in gold
                    </p>
                  </div>
                )}
              </>
            ) : (
              <div className="p-8 text-center">
                <div className="text-6xl mb-4">‚è≥</div>
                <h3 className="font-serif text-2xl font-bold text-primary mb-2">
                  Table Assignment Pending
                </h3>
                <p className="text-secondary">
                  Your table will be assigned soon. Please check back later.
                </p>
              </div>
            )}
          </div>
        );
      }

      // Guest View from QR Code
      function GuestViewFromQR({ qrCode }) {
        const [guestData, setGuestData] = useState(null);
        const [layout, setLayout] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState("");

        useEffect(() => {
          const fetchGuestData = async () => {
            try {
              const [guestRes, layoutRes] = await Promise.all([
                fetch(`${API_BASE}/guest/${qrCode}`),
                fetch(`${API_BASE}/guest/${qrCode}/layout`),
              ]);

              if (!guestRes.ok) {
                throw new Error("Invalid QR code");
              }

              setGuestData(await guestRes.json());
              setLayout(await layoutRes.json());
            } catch (err) {
              setError(err.message);
            } finally {
              setLoading(false);
            }
          };

          fetchGuestData();
        }, [qrCode]);

        if (loading) {
          return (
            <div className="min-h-screen pattern-bg flex items-center justify-center">
              <div className="text-center">
                <div className="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p className="text-secondary">Loading your invitation...</p>
              </div>
            </div>
          );
        }

        if (error) {
          return (
            <div className="min-h-screen pattern-bg flex items-center justify-center p-4">
              <div className="glass rounded-xl p-8 max-w-md text-center">
                <div className="text-6xl mb-4">‚ùå</div>
                <h2 className="font-serif text-3xl font-bold text-primary mb-2">
                  Invalid QR Code
                </h2>
                <p className="text-secondary mb-6">{error}</p>
                <p className="text-sm text-secondary">
                  Please contact the event organizer if you believe this is an
                  error.
                </p>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen pattern-bg py-8 px-4">
            <div className="max-w-2xl mx-auto">
              <GuestView guestData={guestData} layout={layout} />
            </div>
          </div>
        );
      }

      // Main App Component
      function App() {
        const [currentView, setCurrentView] = useState("events");
        const [selectedEventId, setSelectedEventId] = useState(null);
        const [showCreateEvent, setShowCreateEvent] = useState(false);
        const [guestQRCode, setGuestQRCode] = useState(null);

        // Check URL for guest QR code on mount
        useEffect(() => {
          const checkHash = () => {
            const hash = window.location.hash;
            const guestMatch = hash.match(/^#\/guest\/([a-f0-9-]+)$/i);

            if (guestMatch) {
              setGuestQRCode(guestMatch[1]);
              setCurrentView("guest");
            }
          };

          checkHash();
          window.addEventListener("hashchange", checkHash);

          return () => window.removeEventListener("hashchange", checkHash);
        }, []);

        const handleSelectEvent = (eventId) => {
          setSelectedEventId(eventId);
          setCurrentView("dashboard");
        };

        const handleCreateEvent = (eventId) => {
          setShowCreateEvent(false);
          handleSelectEvent(eventId);
        };

        // If viewing guest page, don't show navigation
        if (currentView === "guest" && guestQRCode) {
          return <GuestViewFromQR qrCode={guestQRCode} />;
        }

        return (
          <div className="min-h-screen">
            <Navigation currentView={currentView} onNavigate={setCurrentView} />

            {currentView === "events" && (
              <EventsList
                onSelectEvent={handleSelectEvent}
                onCreateEvent={() => setShowCreateEvent(true)}
              />
            )}

            {currentView === "dashboard" && selectedEventId && (
              <EventDashboard
                eventId={selectedEventId}
                onBack={() => setCurrentView("events")}
              />
            )}

            {currentView === "demo" && <GuestViewDemo />}

            {showCreateEvent && (
              <CreateEventModal
                onClose={() => setShowCreateEvent(false)}
                onSuccess={handleCreateEvent}
              />
            )}
          </div>
        );
      }

      // Render App
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
